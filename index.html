<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>JaseMaster — Wu-Tang Yellow (Playback Fixed)</title>
  <style>
    :root{
      --bg:#fff8d6; --panel:#fff; --ink:#111; --muted:#555; --yellow:#ffd400; --shadow:0 10px 30px rgba(0,0,0,.10);
      --ok:#0a7a2f; --warn:#a14b00; --bad:#b40000;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);
      background: radial-gradient(1200px 600px at 25% 0%, #ffea76, transparent 60%), linear-gradient(180deg, #fff5b5, var(--bg) 40%, #fff);}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(90deg, rgba(255,212,0,.95), rgba(255,255,255,.9));
      border-bottom:1px solid rgba(0,0,0,.08);backdrop-filter:blur(8px);}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand h1{margin:0;font-size:22px}
    .brand p{margin:4px 0 0;color:rgba(0,0,0,.70);font-size:13px;font-weight:700}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid rgba(0,0,0,.12);border-radius:999px;padding:10px 14px;background:var(--panel);font-weight:900;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.06)}
    .btn.primary{background:var(--yellow);border-color:rgba(0,0,0,.22)}
    .btn.dark{background:#111;color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.08);
      font-weight:1000;font-size:13px;white-space:nowrap;color:var(--ok);box-shadow:0 10px 22px rgba(0,0,0,.06)}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid rgba(0,0,0,.10);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .hd{padding:14px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      border-bottom:1px solid rgba(0,0,0,.07);background:linear-gradient(180deg, rgba(255,212,0,.18), transparent)}
    .hd h2{margin:0;font-size:16px}
    .meta{color:var(--muted);font-size:13px;font-weight:800}
    .bd{padding:14px 16px}
    .fileline{display:flex;gap:10px;align-items:center;flex-wrap:wrap;border:1px dashed rgba(0,0,0,.18);padding:10px 12px;border-radius:14px;background:rgba(255,212,0,.06)}
    .small{font-size:12px;color:var(--muted);font-weight:800}
    .wave{width:100%;height:120px;border-radius:16px;background:linear-gradient(180deg, rgba(0,0,0,.04), rgba(0,0,0,.02));
      border:1px solid rgba(0,0,0,.08);overflow:hidden}
    .wave canvas{width:100%;height:100%;display:block}
    .transport{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .toggle{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:8px 10px;border:1px solid rgba(0,0,0,.10);
      border-radius:14px;background:rgba(0,0,0,.02);font-weight:900;font-size:13px}
    .toggle input{transform:scale(1.15)}
    .section{border:1px solid rgba(0,0,0,.10);border-radius:16px;padding:12px;background:rgba(255,255,255,.75);margin-top:12px}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>JaseMaster</h1>
        <p>Playback-fixed (mobile-safe) • Original / Mastered / Reference players</p>
      </div>
      <div class="actions">
        <button class="btn primary" id="autoBtn" disabled>Auto-Master</button>
        <button class="btn dark" id="exportBtn" disabled>Export WAV</button>
        <span class="pill" id="statusPill">Load audio to begin</span>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid">
      <div class="col">
        <div class="card">
          <div class="hd">
            <h2>Original <span class="meta" id="origMeta">—</span></h2>
          </div>
          <div class="bd">
            <div class="fileline">
              <input type="file" id="inputMain" accept="audio/*">
              <span class="small" id="mainInfo">Upload a WAV/MP3.</span>
            </div>
            <div class="wave"><canvas id="waveOrig"></canvas></div>
            <div class="transport">
              <button class="btn" id="playOrig" disabled>Play</button>
              <button class="btn" id="pauseOrig" disabled>Pause</button>
              <button class="btn" id="stopOrig" disabled>Stop</button>
              <span class="small" id="origTime">00:00</span>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="hd">
            <h2>Mastered <span class="meta" id="mastMeta">—</span></h2>
          </div>
          <div class="bd">
            <div class="wave"><canvas id="waveMast"></canvas></div>
            <div class="transport">
              <button class="btn" id="playMast" disabled>Play</button>
              <button class="btn" id="pauseMast" disabled>Pause</button>
              <button class="btn" id="stopMast" disabled>Stop</button>
              <label class="toggle" title="Match loudness so you judge tone not volume.">
                <input type="checkbox" id="levelMatch" checked> Level-match
              </label>
              <span class="small" id="mastTime">00:00</span>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="hd">
            <h2>Reference <span class="meta" id="refMeta">—</span></h2>
          </div>
          <div class="bd">
            <div class="fileline">
              <input type="file" id="inputRef" accept="audio/*">
              <span class="small">Optional: load a pro track for comparison.</span>
            </div>
            <div class="wave"><canvas id="waveRef"></canvas></div>
            <div class="transport">
              <button class="btn" id="playRef" disabled>Play</button>
              <button class="btn" id="pauseRef" disabled>Pause</button>
              <button class="btn" id="stopRef" disabled>Stop</button>
              <span class="small" id="refTime">00:00</span>
            </div>

            <div class="section">
              <div class="small">
                If Play does nothing: your browser is blocking audio. Tap Play again (it unlocks AudioContext), or switch silent mode off on iPhone.
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <div class="hd">
            <h2>Diagnostics</h2>
            <span class="meta" id="diag">—</span>
          </div>
          <div class="bd">
            <div class="small" id="diag2">
              If anything fails, it will show in the status pill with the real reason.
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</main>

<script>
const $ = (id)=>document.getElementById(id);

const state = {
  ctx: null,
  original: null,
  mastered: null,
  reference: null,
  analysis: { orig:null, mast:null, ref:null },
  players: {
    orig: makePlayer(),
    mast: makePlayer(),
    ref:  makePlayer(),
  }
};

function setStatus(msg, kind="ok"){
  const p=$("statusPill");
  p.textContent = msg;
  p.style.color = kind==="ok" ? "var(--ok)" : (kind==="warn" ? "var(--warn)" : "var(--bad)");
}

function ensureCtx(){
  if (!state.ctx){
    state.ctx = new (window.AudioContext || window.webkitAudioContext)();
    // iOS unlock helpers
    const unlock = async ()=>{
      try{
        if (state.ctx.state === "suspended") await state.ctx.resume();
      }catch(e){}
      window.removeEventListener("touchend", unlock, true);
      window.removeEventListener("click", unlock, true);
      window.removeEventListener("keydown", unlock, true);
    };
    window.addEventListener("touchend", unlock, true);
    window.addEventListener("click", unlock, true);
    window.addEventListener("keydown", unlock, true);
  }
  return state.ctx;
}

function makePlayer(){
  return {
    src: null,
    gain: null,
    buffer: null,
    startTime: 0,
    offset: 0,
    playing: false,
    get time(){
      if (!this.playing) return this.offset;
      return this.offset + (ensureCtx().currentTime - this.startTime);
    }
  };
}

function stopPlayer(p){
  try{ if (p.src) p.src.stop(0); }catch(e){}
  try{ if (p.src) p.src.disconnect(); }catch(e){}
  p.src=null; p.gain=null; p.playing=false; p.startTime=0; p.offset=0;
}

function pausePlayer(p){
  if (!p.playing) return;
  p.offset = p.time;
  stopPlayer(p);
}

async function playPlayer(p, buffer, gain=1.0){
  try{
    const ctx = ensureCtx();
    if (ctx.state === "suspended") await ctx.resume();

    // Always create a NEW BufferSource (one-shot node)
    stopPlayer(p);
    p.buffer = buffer;

    const src = ctx.createBufferSource();
    src.buffer = buffer;

    const g = ctx.createGain();
    g.gain.value = gain;

    src.connect(g).connect(ctx.destination);

    p.src = src;
    p.gain = g;
    p.startTime = ctx.currentTime;
    p.playing = true;

    const off = Math.max(0, Math.min(p.offset||0, buffer.duration-0.01));
    src.start(0, off);

    src.onended = ()=>{ p.playing=false; };

  }catch(err){
    console.error(err);
    setStatus("Play failed: " + (err?.message || err), "bad");
  }
}

function fmtTime(sec){
  sec = Math.max(0, sec|0);
  const m = String(Math.floor(sec/60)).padStart(2,'0');
  const s = String(sec%60).padStart(2,'0');
  return `${m}:${s}`;
}

function gainToDb(g){ return 20*Math.log10(Math.max(1e-12,g)); }

function analyze(buffer){
  const L = buffer.getChannelData(0);
  const R = buffer.numberOfChannels>1 ? buffer.getChannelData(1) : null;
  let peak=0, sum=0;
  for(let i=0;i<L.length;i++){
    const v = R ? 0.5*(L[i]+R[i]) : L[i];
    const a = Math.abs(v);
    if(a>peak) peak=a;
    sum += v*v;
  }
  const rms = Math.sqrt(sum/L.length);
  return { peakDb: gainToDb(peak), rmsDb: gainToDb(rms), dur: buffer.duration, sr: buffer.sampleRate, ch: buffer.numberOfChannels };
}

function setMeta(which, a){
  const id = which==="orig" ? "origMeta" : which==="mast" ? "mastMeta" : "refMeta";
  if (!a){ $(id).textContent="—"; return; }
  $(id).textContent = `${a.ch}ch • ${Math.round(a.sr/1000)}kHz • Peak ${a.peakDb.toFixed(1)} dB • RMS ${a.rmsDb.toFixed(1)} dB • ${fmtTime(a.dur)}`;
}

function computePeaks(buffer, bins=900){
  const L = buffer.getChannelData(0);
  const R = buffer.numberOfChannels>1 ? buffer.getChannelData(1) : null;
  const len=L.length;
  const size=Math.max(1, Math.floor(len/bins));
  const peaks=new Float32Array(bins);
  for(let i=0;i<bins;i++){
    const s=i*size, e=(i===bins-1)?len:(s+size);
    let m=0;
    for(let j=s;j<e;j++){
      const v=R ? 0.5*(Math.abs(L[j])+Math.abs(R[j])) : Math.abs(L[j]);
      if(v>m) m=v;
    }
    peaks[i]=m;
  }
  return peaks;
}

function drawWave(canvas, peaks){
  const ctx2d=canvas.getContext("2d");
  const dpr=window.devicePixelRatio||1;
  const w=canvas.clientWidth, h=canvas.clientHeight;
  canvas.width=Math.floor(w*dpr); canvas.height=Math.floor(h*dpr);
  ctx2d.setTransform(dpr,0,0,dpr,0,0);
  ctx2d.clearRect(0,0,w,h);

  ctx2d.globalAlpha=0.18;
  ctx2d.fillStyle="#111";
  ctx2d.fillRect(0,h/2,w,1);
  ctx2d.globalAlpha=1;

  const n=peaks.length;
  const step=w/n;
  ctx2d.fillStyle="#111";
  for(let i=0;i<n;i++){
    const p=peaks[i];
    const barH=Math.max(1, p*(h*0.9));
    const y=(h-barH)/2;
    ctx2d.fillRect(i*step,y,Math.max(1,step*0.9),barH);
  }
}

function enableBlock(which, on){
  const map = {
    orig: ["playOrig","pauseOrig","stopOrig"],
    mast: ["playMast","pauseMast","stopMast"],
    ref:  ["playRef","pauseRef","stopRef"]
  };
  map[which].forEach(id=>$(id).disabled=!on);
}

// main load
$("inputMain").addEventListener("change", async (e)=>{
  const f=e.target.files?.[0];
  if(!f) return;
  try{
    setStatus("Loading original…","warn");
    stopPlayer(state.players.orig);
    const ctx=ensureCtx();
    const arr=await f.arrayBuffer();
    const buf=await ctx.decodeAudioData(arr.slice(0));
    state.original=buf;
    state.analysis.orig=analyze(buf);
    setMeta("orig", state.analysis.orig);
    drawWave($("waveOrig"), computePeaks(buf));
    enableBlock("orig", true);

    $("autoBtn").disabled=false;
    setStatus("Original loaded. Tap Play.","ok");
  }catch(err){
    console.error(err);
    setStatus("Load failed (try WAV/MP3): " + (err?.message||err), "bad");
  }
});

// reference load
$("inputRef").addEventListener("change", async (e)=>{
  const f=e.target.files?.[0];
  if(!f) return;
  try{
    setStatus("Loading reference…","warn");
    stopPlayer(state.players.ref);
    const ctx=ensureCtx();
    const arr=await f.arrayBuffer();
    const buf=await ctx.decodeAudioData(arr.slice(0));
    state.reference=buf;
    state.analysis.ref=analyze(buf);
    setMeta("ref", state.analysis.ref);
    drawWave($("waveRef"), computePeaks(buf));
    enableBlock("ref", true);
    setStatus("Reference loaded. Tap Play.","ok");
  }catch(err){
    console.error(err);
    setStatus("Reference load failed: " + (err?.message||err), "bad");
  }
});

function getLevelMatchedGain(){
  if (!$("levelMatch").checked) return 1.0;
  const o=state.analysis.orig, m=state.analysis.mast;
  if(!o || !m) return 1.0;
  const deltaDb = o.rmsDb - m.rmsDb;
  return Math.pow(10, deltaDb/20);
}

// transport wiring
$("playOrig").onclick = ()=> state.original && playPlayer(state.players.orig, state.original, 1.0);
$("pauseOrig").onclick = ()=> pausePlayer(state.players.orig);
$("stopOrig").onclick = ()=> { stopPlayer(state.players.orig); $("origTime").textContent="00:00"; };

$("playRef").onclick  = ()=> state.reference && playPlayer(state.players.ref, state.reference, 1.0);
$("pauseRef").onclick = ()=> pausePlayer(state.players.ref);
$("stopRef").onclick  = ()=> { stopPlayer(state.players.ref); $("refTime").textContent="00:00"; };

$("playMast").onclick = ()=> state.mastered && playPlayer(state.players.mast, state.mastered, getLevelMatchedGain());
$("pauseMast").onclick= ()=> pausePlayer(state.players.mast);
$("stopMast").onclick = ()=> { stopPlayer(state.players.mast); $("mastTime").textContent="00:00"; };

// time updates
setInterval(()=>{
  const p=state.players.orig; if(p.buffer) $("origTime").textContent=fmtTime(p.time);
  const r=state.players.ref;  if(r.buffer) $("refTime").textContent=fmtTime(r.time);
  const m=state.players.mast; if(m.buffer) $("mastTime").textContent=fmtTime(m.time);
  $("diag").textContent = `AudioContext: ${state.ctx ? state.ctx.state : "not created"}`;
}, 250);

// placeholder mastering (you will replace with your full chain)
$("autoBtn").addEventListener("click", async ()=>{
  if(!state.original) return;
  try{
    setStatus("Auto-Master (demo): copying original → mastered","warn");
    // For now: just copy original (pro chain goes here)
    state.mastered = state.original;
    state.analysis.mast = analyze(state.mastered);
    setMeta("mast", state.analysis.mast);
    drawWave($("waveMast"), computePeaks(state.mastered));
    enableBlock("mast", true);

    $("exportBtn").disabled=false;
    setStatus("Master ready. Play Mastered.","ok");
  }catch(err){
    console.error(err);
    setStatus("Auto-master failed: " + (err?.message||err), "bad");
  }
});
</script>
</body>
</html>
