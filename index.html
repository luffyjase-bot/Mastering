<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>AceMaster 5000 ‚Äî Clear UX</title>
<script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/browser-id3-writer@4.4.0/dist/browser-id3-writer.min.js"></script>

<style>
  /* --- THEME --- */
  :root {
    --chassis: #e0e5ec;
    --ink: #2b2b2b;
    --accent: #ffcc00;
    --accent-dim: #d4b000;
    --led-off: #444;
    --led-on: #00ff41;
    --led-busy: #ffaa00;
    --led-warn: #ff3333;
    
    --shadow-soft: 9px 9px 16px #a3b1c6, -9px -9px 16px #ffffff;
    --shadow-inset: inset 6px 6px 10px #a3b1c6, inset -6px -6px 10px #ffffff;
    --knob-shadow: 6px 6px 10px rgba(0,0,0,0.15), -2px -2px 5px rgba(255,255,255,0.8);
    --bezel-shadow: inset 2px 2px 5px rgba(0,0,0,0.2), 1px 1px 0 rgba(255,255,255,1);
  }

  body { margin: 0; background: #d0d0d0; font-family: ui-sans-serif, system-ui, sans-serif; color: var(--ink); padding: 20px; display: flex; justify-content: center; min-height: 100vh; user-select: none; }
  .rack { width: 100%; max-width: 1020px; display: flex; flex-direction: column; gap: 25px; position: relative; }

  /* OVERLAYS */
  .drop-zone {
    position: absolute; inset: -20px; background: rgba(255,212,0,0.9); z-index: 999;
    display: flex; align-items: center; justify-content: center;
    font-size: 30px; font-weight: 900; color: #000; text-transform: uppercase;
    opacity: 0; pointer-events: none; transition: opacity 0.2s; border-radius: 10px;
  }
  .drop-active .drop-zone { opacity: 1; pointer-events: all; }

  .loading-overlay {
    position: absolute; inset: 0; background: rgba(255,255,255,0.95); z-index: 500;
    display: none; align-items: center; justify-content: center; flex-direction: column; gap: 15px;
    border-radius: 24px; backdrop-filter: blur(5px);
  }
  .progress-bar-wrap { width: 200px; height: 6px; background: #ddd; border-radius: 3px; overflow: hidden; }
  .progress-bar { height: 100%; background: var(--accent-dim); width: 0%; transition: width 0.1s; }
  .spinner { width: 40px; height: 40px; border: 5px solid #ccc; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .progress-text { font-family: monospace; font-weight: 700; font-size: 14px; color: #555; }

  .banner {
    display:none;
    background: rgba(255,51,51,0.12);
    border: 1px solid rgba(255,51,51,0.5);
    color: #ffb3b3;
    padding: 10px 12px;
    border-radius: 10px;
    font-weight: 900;
    font-size: 12px;
    text-align: center;
    margin-bottom: 10px;
  }
  .banner.show { display:block; animation: fadein 0.3s; }
  @keyframes fadein { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }

  /* FACEPLATE */
  .faceplate {
    background: var(--chassis); border: 1px solid #fff; border-radius: 20px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.25); padding: 30px; position: relative;
    display: flex; flex-direction: column; gap: 25px;
  }
  .screw {
    position: absolute; width: 14px; height: 14px; background: #888; border-radius: 50%;
    box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5), 1px 1px 0 rgba(255,255,255,0.8);
    background-image: linear-gradient(45deg, transparent 46%, #333 46%, #333 54%, transparent 54%);
  }
  .tl { top: 12px; left: 12px; } .tr { top: 12px; right: 12px; } .bl { bottom: 12px; left: 12px; } .br { bottom: 12px; right: 12px; }

  /* HEADER */
  .brand-strip { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid rgba(0,0,0,0.05); padding-bottom: 15px; }
  .logo { font-size: 26px; font-weight: 900; letter-spacing: -1px; display: flex; align-items: center; gap: 10px; }
  .logo span { background: #222; color: var(--accent); padding: 2px 8px; border-radius: 4px; font-size: 14px; letter-spacing: 2px; }
  .model-id { font-family: monospace; font-weight: 700; color: #888; font-size: 12px; }

  /* METER BRIDGE */
  .meter-bridge {
    display: grid; grid-template-columns: 2fr 1fr; gap: 15px; height: 160px;
    background: #222; padding: 15px; border-radius: 12px; border: 2px solid #444;
    box-shadow: inset 0 0 20px #000;
  }
  .screen-wrap { background: #000; border-radius: 6px; border: 1px solid #333; position: relative; overflow: hidden; }
  canvas { width: 100%; height: 100%; display: block; }
  .screen-glare { position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,0.05), transparent 40%); pointer-events: none; }
  .screen-overlay { position: absolute; top: 10px; left: 15px; right: 15px; display: flex; justify-content: space-between; pointer-events: none; }
  .badge { background: rgba(255,212,0,0.9); color: #000; padding: 3px 6px; font-size: 10px; font-weight: 900; border-radius: 3px; }
  .metric { font-family: monospace; color: var(--accent); font-size: 12px; text-shadow: 0 0 5px var(--accent); }
  
  .vu-section { display: flex; flex-direction: column; gap: 5px; }
  .vu-header { display:flex; justify-content:space-between; align-items:center; }
  .vu-box { flex: 1; background: #e8e8e0; border-radius: 4px; position: relative; overflow: hidden; box-shadow: inset 0 0 15px rgba(0,0,0,0.4); border: 1px solid #000; }
  .vu-scale { position: absolute; bottom: 10px; left: 10%; right: 10%; height: 2px; background: #333; }
  .vu-needle { width: 2px; height: 85%; background: #d00; position: absolute; bottom: 0; left: 50%; transform-origin: bottom center; transform: rotate(45deg); transition: transform 0.1s ease-out; box-shadow: 2px 2px 4px rgba(0,0,0,0.3); z-index: 2; }
  .vu-label { text-align: center; color: #666; font-size: 10px; font-weight: 800; margin-top: -30px; z-index: 1; position: relative; }
  .vu-title { color: #888; font-size: 10px; text-align: center; font-weight: 700; text-transform: uppercase; }

  /* PLAYERS */
  .players { display: grid; gap: 12px; margin-bottom: 20px; }
  .panel {
    background: #1f1f1f;
    border: 1px solid #444;
    border-radius: 12px;
    overflow: hidden;
  }
  .panel summary {
    list-style: none;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    gap: 10px;
    align-items: center;
    padding: 12px 14px;
    font-weight: 900;
    letter-spacing: 1px;
    color: #fff;
    background: #2a2a2a;
    transition: background 0.2s;
  }
  .panel summary:hover { background: #333; }
  .panel summary::-webkit-details-marker { display:none; }
  .panel-body { padding: 12px 14px; display: grid; gap: 10px; background: #222; }

  .status-pill {
    font-family: ui-monospace, monospace;
    font-size: 11px;
    font-weight: 900;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid #555;
    color: #ddd;
    background: #111;
  }
  .status-ok { border-color: #1f8f3a; color:#bfffcf; background: rgba(31, 143, 58, 0.2); }
  .status-busy { border-color: #b58b00; color:#ffeaa8; background: rgba(181, 139, 0, 0.2); }
  .status-warn { border-color: #b50000; color:#ffb3b3; background: rgba(181, 0, 0, 0.2); }

  .panel-actions { display:flex; flex-wrap: wrap; gap: 8px; align-items:center; }
  .pbtn {
    border: 1px solid #555;
    background: #333;
    color: #ddd;
    font-weight: 900;
    font-size: 11px;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.1s;
  }
  .pbtn:hover:not(:disabled) { background: #444; border-color: #777; }
  .pbtn:disabled { opacity: 0.45; cursor: not-allowed; }
  .pbtn.primary { border-color: var(--accent); color: #000; background: var(--accent); }
  .pbtn.primary:hover:not(:disabled) { background: #ffdb4d; }
  .pbtn.danger { border-color: #ff3333; color: #ffb3b3; background: transparent; }
  .pbtn.danger:hover:not(:disabled) { background: rgba(255, 51, 51, 0.2); }
  audio { width: 100%; height: 32px; filter: invert(0.9); }

  /* CONTROLS */
  .knob-deck { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; background: linear-gradient(to bottom, #f9f9f9, #e0e0e0); padding: 25px; border-radius: 12px; box-shadow: var(--bezel-shadow); border: 1px solid #ccc; transition: opacity 0.3s; }
  .knob-deck.hidden { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
  .module { display: flex; flex-direction: column; align-items: center; gap: 10px; }
  .mod-name { font-size: 10px; font-weight: 800; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
  .knob-pot { width: 64px; height: 64px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #fff, #ccc); box-shadow: var(--knob-shadow); position: relative; cursor: ns-resize; }
  .knob-pot::after { content: ''; position: absolute; top: 5px; left: 50%; width: 4px; height: 20px; background: #333; transform: translateX(-50%); border-radius: 2px; }
  .knob-inner { width: 100%; height: 100%; transition: transform 0.05s; border-radius: 50%; }
  .knob-val { font-family: monospace; font-size: 11px; font-weight: 700; color: var(--ink); background: #fff; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; }

  /* SWITCHES */
  .switch-row { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin-top: 15px; transition: opacity 0.3s; }
  .switch-row.hidden { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
  .push-switch { appearance: none; border: none; background: var(--chassis); color: #666; padding: 8px 14px; border-radius: 8px; font-size: 10px; font-weight: 800; box-shadow: var(--shadow-soft); cursor: pointer; transition: 0.1s; }
  .push-switch.active { box-shadow: var(--shadow-inset); color: #222; border-left: 3px solid var(--accent); }

  /* MODAL */
  .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
  .modal-box { background: #eee; padding: 20px; border-radius: 12px; max-width: 450px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.8); font-family: ui-monospace, monospace; font-size: 12px; line-height: 1.6; max-height: 90vh; overflow-y: auto; user-select: text; }
  input { border: 1px solid #ccc; padding: 4px; border-radius: 4px; font-family: inherit; font-size: 12px; }

  /* TOGGLE MODE */
  .mode-toggle { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 10px; }
  .toggle-switch { position: relative; width: 60px; height: 24px; }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 12px; box-shadow: var(--shadow-inset); }
  .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
  input:checked + .slider { background-color: var(--ink); }
  input:checked + .slider:before { transform: translateX(36px); background-color: var(--accent); }
  
  /* PRESETS */
  .preset-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 10px 0; }
  .preset-btn { background: var(--chassis); color: #666; border: none; padding: 8px 14px; border-radius: 6px; font-size: 10px; font-weight: 800; letter-spacing: 1px; cursor: pointer; box-shadow: var(--shadow-soft); transition: all 0.1s; min-width: 60px; }
  .preset-btn:active, .preset-btn.active { box-shadow: var(--shadow-inset); color: #222; border-left: 3px solid var(--accent); transform: translateY(1px); }
  .preset-desc { text-align: center; font-size: 10px; font-weight: 700; color: #777; font-style: italic; min-height: 14px; }

  /* DRAWER */
  .drawer { background: #222; margin-top: -5px; border-radius: 0 0 12px 12px; padding: 20px; border: 1px solid #444; border-top: none; }
  .drawer.locked { opacity: 0.6; filter: grayscale(1); pointer-events: none; }
  .drawer-head { color: #666; font-size: 10px; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; }
  .drawer-sub { color: #9a9a9a; font-size: 10px; margin-bottom: 10px; font-style: italic; }
  .mixer-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
  .fader-strip { min-width: 80px; background: #1a1a1a; padding: 10px 5px; border-radius: 4px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
  .mini-fader { -webkit-appearance: slider-vertical; width: 24px; height: 100px; background: #333; }
  .stem-name { font-size: 10px; color: #aaa; width: 100%; overflow: hidden; text-overflow: ellipsis; text-align: center; font-weight: 700; }
  
  .target-row { display: flex; justify-content: center; gap: 5px; opacity: 0.8; margin-top:10px;}
  .target-btn { background: #ccc; color: #555; border: none; padding: 4px 8px; border-radius: 4px; font-size: 9px; font-weight: 700; cursor: pointer; }
  .target-btn:hover { background: #bbb; color: #222; }

  @media(max-width: 800px) { .knob-deck { grid-template-columns: 1fr 1fr 1fr; } .meter-bridge { grid-template-columns: 1fr; height: auto; } .vu-section { display: none; } }
</style>
</head>
<body>

<script type="module">
  const workerCode = `
    import { FFmpeg } from "https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/esm/index.js";
    import { toBlobURL } from "https://unpkg.com/@ffmpeg/util@0.12.1/dist/esm/index.js";

    let ffmpeg = null;
    let ffReady = false;
    let cancelled = false;

    function parseLoudnorm(text) {
      const matches = text.match(/\\{[\\s\\S]*?\\}/g);
      if (!matches) return null;
      try { return JSON.parse(matches[matches.length - 1]); } catch { return null; }
    }

    function parseEbur128(text) {
      const iMatch = text.match(/\\bI:\\s*([-\\d.]+)\\s*LUFS/i);
      const tpMatch = text.match(/\\bTP:\\s*([-\\d.]+)\\s*dB(?:TP)?/i);
      return {
        I: iMatch ? parseFloat(iMatch[1]) : null,
        TP: tpMatch ? parseFloat(tpMatch[1]) : null
      };
    }

    async function ensureFFmpeg() {
      if (ffReady) return true;
      ffmpeg = new FFmpeg();
      const baseURL = "https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm";
      await ffmpeg.load({
        coreURL: await toBlobURL(\`\${baseURL}/ffmpeg-core.js\`, "text/javascript"),
        wasmURL: await toBlobURL(\`\${baseURL}/ffmpeg-core.wasm\`, "application/wasm"),
      });
      ffReady = true;
      return true;
    }

    async function analyzeLoudness(wavBytes) {
      cancelled = false;
      await ensureFFmpeg();
      const inName = "scan.wav";
      await ffmpeg.writeFile(inName, new Uint8Array(wavBytes));
      let logs = "";
      ffmpeg.on("log", ({ message }) => { logs += message + "\\n"; });
      await ffmpeg.exec(["-i", inName, "-af", "ebur128=peak=true", "-f", "null", "-"]);
      await ffmpeg.deleteFile(inName);
      if (cancelled) return { cancelled: true };
      return { cancelled: false, metrics: parseEbur128(logs) };
    }

    async function applyCompliance(wavBytes, targetI, targetTP) {
      cancelled = false;
      await ensureFFmpeg();
      const inName = "source.wav";
      const outName = "master.wav";
      await ffmpeg.writeFile(inName, new Uint8Array(wavBytes));
      let logs = "";
      ffmpeg.on("log", ({ message }) => { logs += message + "\\n"; });
      
      await ffmpeg.exec(["-i", inName, "-af", \`loudnorm=I=\${targetI}:TP=\${targetTP}:print_format=json\`, "-f", "null", "-"]);
      const meas = parseLoudnorm(logs);
      if (!meas) return { cancelled: false, error: "measure failed" };
      if (cancelled) return { cancelled: true };

      await ffmpeg.exec([
        "-i", inName,
        "-af", \`loudnorm=I=\${targetI}:TP=\${targetTP}:measured_I=\${meas.input_i}:measured_LRA=\${meas.input_lra}:measured_TP=\${meas.input_tp}:measured_thresh=\${meas.input_thresh}:offset=\${meas.target_offset}:linear=true:print_format=json\`,
        "-ar", "44100", outName
      ]);

      const data = await ffmpeg.readFile(outName);
      await ffmpeg.deleteFile(inName); await ffmpeg.deleteFile(outName);
      if (cancelled) return { cancelled: true };
      return { cancelled: false, buffer: data.buffer, stats: meas };
    }

    self.onmessage = async (e) => {
      const { id, op, wavBytes, targetI, targetTP } = e.data || {};
      try {
        if (op === "cancel") {
          cancelled = true;
          self.postMessage({ id, ok: true, cancelled: true });
          return;
        }
        if (op === "analyze") {
          const res = await analyzeLoudness(wavBytes);
          self.postMessage({ id, ok: true, ...res });
          return;
        }
        if (op === "compliance") {
          const res = await applyCompliance(wavBytes, targetI, targetTP);
          self.postMessage({ id, ok: true, ...res });
          return;
        }
      } catch (err) {
        self.postMessage({ id, ok: false, error: String(err?.message || err) });
      }
    };
  `;

  const ffWorker = new Worker(URL.createObjectURL(new Blob([workerCode], { type: "text/javascript" })), { type: "module" });
  let _reqId = 0; const pending = new Map();

  function callWorker(op, payload = {}) {
    const id = ++_reqId;
    return new Promise((resolve, reject) => {
      pending.set(id, { resolve, reject });
      ffWorker.postMessage({ id, op, ...payload }, payload.wavBytes ? [payload.wavBytes] : []);
    });
  }

  ffWorker.onmessage = (e) => {
    const { id, ok, ...rest } = e.data || {};
    const p = pending.get(id);
    if (!p) return;
    pending.delete(id);
    ok ? p.resolve(rest) : p.reject(new Error(rest.error || "Worker error"));
  };

  window.__ff = {
    analyze: (wavBytes) => callWorker("analyze", { wavBytes }),
    compliance: (wavBytes, targetI, targetTP) => callWorker("compliance", { wavBytes, targetI, targetTP }),
    cancel: () => callWorker("cancel", {})
  };
</script>

<div class="rack" id="rack">
  <div class="drop-zone">Drop Files Here</div>
  <div class="loading-overlay" id="loader">
    <div class="spinner"></div>
    <div class="progress-text" id="progressText">PROCESSING...</div>
    <div class="progress-bar-wrap"><div class="progress-bar" id="progressBar"></div></div>
    <button class="push-switch" id="cancelBtn" style="margin-top:15px;">CANCEL</button>
  </div>

  <div class="faceplate">
    <div class="screw tl"></div><div class="screw tr"></div><div class="screw bl"></div><div class="screw br"></div>
    <div class="brand-strip">
      <div class="logo">AceMaster <span>5000</span></div>
      <div style="display:flex; align-items:center; gap:10px;">
        <div class="mode-toggle">
          <span style="font-size:10px; font-weight:800; color:#666;">AUTO</span>
          <label class="toggle-switch"><input type="checkbox" id="proModeToggle"><span class="slider"></span></label>
          <span style="font-size:10px; font-weight:800; color:#222;">PRO</span>
        </div>
        <div id="statusLed" class="led"></div>
      </div>
    </div>
    
    <div class="meter-bridge">
      <div class="screen-wrap">
        <canvas id="fftCanvas"></canvas>
        <div class="screen-glare"></div>
        <div class="screen-overlay">
          <span class="badge" id="modeBadge">READY</span>
          <span class="metric" id="kpiMetric">-Inf LUFS</span>
        </div>
        <div class="warn-msg" id="warnMsg"></div>
      </div>
      <div class="vu-section">
        <div class="vu-header"><div class="vu-title">Reduction</div><div class="clip-led" id="clipLed" title="Clip Warning"></div></div>
        <div class="vu-box"><div class="vu-scale"></div><div class="vu-needle" id="vuNeedle"></div><div class="vu-label">GR</div></div>
      </div>
    </div>

    <div style="margin: 15px 0; display:flex; gap:10px; justify-content:center;">
        <label class="preset-btn" style="color:var(--ink); font-weight:900;">
          üìÇ LOAD SOURCE <input type="file" id="fileInput" accept=".wav,.mp3,.ogg,audio/*" multiple style="display:none">
        </label>
        <label class="preset-btn" style="background:#bbb;">
          REF TRACK <input type="file" id="refInput" accept=".wav,.mp3,.ogg,audio/*" style="display:none">
        </label>
        <button class="preset-btn" id="matchBtn" disabled>MATCH REF</button>
    </div>

    <div class="players">
      <div class="banner" id="issueBanner">‚ö†Ô∏è Not mastered yet. Click <b>MASTER NOW</b> first.</div>

      <details class="panel" id="panelOrig" open>
        <summary>ORIGINAL <span class="status-pill" id="origPill">NOT LOADED</span></summary>
        <div class="panel-body">
          <audio id="audioOrig" controls></audio>
          <div class="panel-actions">
            <button class="pbtn" id="btnOrigPlay" disabled>PLAY ORIGINAL</button>
          </div>
        </div>
      </details>

      <details class="panel" id="panelMast" open>
        <summary>MASTERED <span class="status-pill" id="mastPill">NOT MASTERED</span></summary>
        <div class="panel-body">
          <audio id="audioMast" controls></audio>
          <div class="panel-actions">
            <button class="pbtn primary" id="btnMasterNow" disabled>MASTER NOW</button>
            <button class="pbtn" id="btnMastPlay" disabled>PLAY MASTERED</button>
          </div>
        </div>
      </details>

      <details class="panel" id="panelRef">
        <summary>REFERENCE <span class="status-pill" id="refPill">NOT LOADED</span></summary>
        <div class="panel-body">
          <audio id="audioRef" controls></audio>
        </div>
      </details>
    </div>

    <div class="toolbar">
      <div class="target-row">
        <button class="target-btn" onclick="setKnobValue('k-target',-14);setKnobValue('k-ceiling',-1.0);">Spotify -14</button>
        <button class="target-btn" onclick="setKnobValue('k-target',-16);setKnobValue('k-ceiling',-1.0);">Apple -16</button>
        <button class="target-btn" onclick="setKnobValue('k-target',-9);setKnobValue('k-ceiling',-0.5);">Club -9</button>
      </div>
      <div class="preset-row" id="presetRow"></div>
      <div class="preset-desc" id="presetDesc">Select a preset to begin</div>
    </div>

    <div class="knob-deck hidden" id="knobDeck">
      <div class="module"><div class="mod-name">Target</div><div class="knob-pot" id="k-target" data-min="-18" data-max="-6" data-val="-14" data-step="0.5"><div class="knob-inner"></div></div><div class="knob-val">-14 LUFS</div></div>
      <div class="module"><div class="mod-name">Ceiling</div><div class="knob-pot" id="k-ceiling" data-min="-3.0" data-max="0.0" data-val="-1.0" data-step="0.1"><div class="knob-inner"></div></div><div class="knob-val">-1.0 dB</div></div>
      <div class="module"><div class="mod-name" style="color:var(--accent-dim)">Drive %</div><div class="knob-pot" id="k-drive" data-min="0" data-max="100" data-val="40" data-step="1"><div class="knob-inner"></div></div><div class="knob-val">40%</div></div>
      <div class="module"><div class="mod-name">Character</div><div class="knob-pot" id="k-char" data-min="0" data-max="100" data-val="50" data-step="10"><div class="knob-inner"></div></div><div class="knob-val">Balanced</div></div>
      <div class="module"><div class="mod-name">Width</div><div class="knob-pot" id="k-width" data-min="100" data-max="150" data-val="110" data-step="1"><div class="knob-inner"></div></div><div class="knob-val">110%</div></div>
    </div>

    <div class="switch-row hidden" id="switchRow">
      <button class="push-switch active" id="sw-hpf">HPF 30</button>
      <button class="push-switch active" id="sw-mud">Low Clean</button>
      <button class="push-switch active" id="sw-air">Air 12k</button>
      <button class="push-switch active" id="sw-multi">Multiband</button>
      <button class="push-switch active" id="sw-tube">Tube</button>
      <button class="push-switch active" id="sw-mono">Mono Bass</button>
      <button class="push-switch active" id="sw-dither">Dither</button>
    </div>

    <div style="display:flex; gap:10px; align-items:center; justify-content:center; margin-top:20px; background:#2a2a2a; padding:15px; border-radius:12px;">
      <button class="push-switch" id="undoBtn" disabled>UNDO</button>
      <button class="push-switch" id="tagsBtn">TAGS</button>
      <button class="push-switch" id="resetBtn">RESET</button>
      <select id="exportFmt" style="padding:8px;"><option value="wav">WAV</option><option value="mp3">MP3</option></select>
      <button class="big-go" id="exportBtn" disabled style="background:#fff; color:#000;">SAVE</button>
      <button class="push-switch" id="helpBtn">?</button>
    </div>
  </div>

  <div class="drawer" id="stemDrawer">
    <div class="drawer-head" id="stemHead">FILES</div>
    <div class="drawer-sub" id="stemSub"></div>
    <div class="mixer-row" id="mixerBay"></div>
  </div>
  
  <div class="modal" id="tagsModal"><div class="modal-box"><b>Publisher Metadata</b><br><br><label>Title<br><input id="mTitle" style="width:100%"></label><br><br><label>Artist<br><input id="mArtist" style="width:100%"></label><br><br><label>Album<br><input id="mAlbum" style="width:100%"></label><br><br><div style="display:flex; gap:10px;"><label style="flex:1;">Year<br><input id="mYear" style="width:100%"></label><label style="flex:1;">Genre<br><input id="mGenre" style="width:100%"></label></div><br><label>Cover Art<br><input type="file" id="mCover" accept="image/*" style="width:100%"></label><br><br><div style="display:flex; gap:10px; justify-content:flex-end;"><button class="push-switch" id="tagsClose">CLOSE</button><button class="push-switch active" id="tagsSave">SAVE</button></div></div></div>
  <div class="modal" id="reportModal"><div class="modal-box" id="reportContent"></div></div>
</div>

<script>
/* UTILS */
const $ = id => document.getElementById(id);
const dbToGain = db => Math.pow(10, db/20);
const gainToDb = g => 20 * Math.log10(Math.max(g, 1e-12));
const clamp = (x,a,b) => Math.max(a, Math.min(b,x));
function setProgress(pct, text) { $('progressText').innerText = text || "PROCESSING..."; $('progressBar').style.width = `${clamp(pct,0,100)}%`; }

/* AUDIO HELPER: BUFFER TO WAV BYTES */
function audioBufferToWavBytes(b){
  const nc = Math.min(2, b.numberOfChannels);
  const sr = b.sampleRate;
  const len = b.length;
  const bps = 2; // 16-bit
  const blockAlign = nc * bps;
  const dataSize = len * blockAlign;
  const ab = new ArrayBuffer(44 + dataSize);
  const v = new DataView(ab);
  const w = (o, s) => { for (let i=0;i<s.length;i++) v.setUint8(o+i, s.charCodeAt(i)); };
  w(0,"RIFF"); v.setUint32(4, 36 + dataSize, true); w(8,"WAVE");
  w(12,"fmt "); v.setUint32(16, 16, true);
  v.setUint16(20, 1, true);
  v.setUint16(22, nc, true);
  v.setUint32(24, sr, true);
  v.setUint32(28, sr * blockAlign, true);
  v.setUint16(32, blockAlign, true);
  v.setUint16(34, 16, true);
  w(36,"data"); v.setUint32(40, dataSize, true);
  const ch = [];
  for (let i=0;i<nc;i++) ch.push(b.getChannelData(i));
  let p = 44;
  for (let i=0;i<len;i++){
    for (let c=0;c<nc;c++){
      let s = Math.max(-1, Math.min(1, ch[c][i]));
      v.setInt16(p, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
      p += 2;
    }
  }
  return ab;
}

/* UI STATE & PLAYER LOGIC */
const urls = { orig:null, mast:null, ref:null };
let exportToken = 0;
let renderToken = 0;
let myTokenForExport = 0;

function setPill(id, text, mode){
  const el = $(id); el.textContent = text;
  el.classList.remove('status-ok','status-busy','status-warn');
  if (mode) el.classList.add(mode);
}
function revokeUrl(key){ if (urls[key]) { URL.revokeObjectURL(urls[key]); urls[key]=null; } }
function setAudioFromBuffer(audioEl, key, buf){
  revokeUrl(key);
  const wav = audioBufferToWavBytes(buf);
  const blob = new Blob([wav], { type: "audio/wav" });
  const url = URL.createObjectURL(blob);
  urls[key] = url;
  audioEl.src = url;
  audioEl.load();
}
function stopAllPlayers(){ ['audioOrig','audioMast','audioRef'].forEach(id=>{ const a=$(id); if(a){a.pause(); a.currentTime=0;} }); }
function showIssue(msg){ const b=$('issueBanner'); b.innerHTML=msg||'‚ö†Ô∏è Not mastered yet. Click <b>MASTER NOW</b> first.'; b.classList.add('show'); setTimeout(()=>b.classList.remove('show'),3000); }

/* VISUALIZER */
const canvas=$('fftCanvas'), ctx=canvas.getContext('2d'); let dims={w:0,h:0};
function resize() { const r=canvas.getBoundingClientRect(), d=window.devicePixelRatio||1; canvas.width=Math.max(1,Math.floor(r.width*d)); canvas.height=Math.max(1,Math.floor(r.height*d)); ctx.setTransform(d,0,0,d,0,0); dims={w:r.width,h:r.height}; }
window.addEventListener('resize', resize); resize();

/* --- MAIN AUDIO --- */
const audioCtx=new(window.AudioContext||window.webkitAudioContext)();
let audioUnlocked=false;
async function unlockAudio(){if(audioUnlocked)return; try{if(audioCtx.state==='suspended')await audioCtx.resume(); const o=audioCtx.createOscillator(),g=audioCtx.createGain(); g.gain.value=0.00001; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.01); audioUnlocked=true;}catch(e){}}
['pointerdown','touchstart','click','keydown'].forEach(e=>window.addEventListener(e,unlockAudio,{once:true,passive:true}));

let state={buffers:[],sumBuffer:null,masterBuffer:null,refBuffer:null};

/* FILE LOAD */
async function loadFiles(fileList){
  await unlockAudio(); const all=Array.from(fileList||[]); if(!all.length)return;
  const okMime=new Set(["audio/wav","audio/x-wav","audio/mpeg","audio/mp3","audio/ogg","audio/webm","audio/flac","audio/x-flac"]);
  const files=all.filter(f=>(f.type?okMime.has(f.type):true));
  
  if(!files.length){ alert("No supported audio files selected."); return; }
  
  state.buffers=[]; $('mixerBay').innerHTML=''; 
  try {
    for(const f of files){
        const ab=await f.arrayBuffer(); const b=await audioCtx.decodeAudioData(ab);
        state.buffers.push({buffer:b,name:f.name,gain:0});
    }
    
    // Setup Stems Panel
    const multi = state.buffers.length > 1;
    $('stemDrawer').style.display='block';
    $('stemHead').innerText = multi ? `STEMS (${state.buffers.length})` : "FILE (1)";
    $('stemSub').innerText = multi ? "Mix stems below" : "Single file loaded";
    $('stemDrawer').classList.toggle('locked', !multi);
    buildMixer();
    
    // Mix
    state.sumBuffer = await renderMix(state.buffers);
    setAudioFromBuffer($('audioOrig'), 'orig', state.sumBuffer);
    setPill('origPill', 'LOADED', 'status-ok');
    $('btnOrigPlay').disabled=false; $('btnMasterNow').disabled=false;
    $('modeBadge').innerText="Original Ready";
    
  } catch(e){ alert("Load Error: "+e); }
}
$('fileInput').onchange=e=>loadFiles(e.target.files);

/* MIXER */
function buildMixer(){
  $('mixerBay').innerHTML="";
  const multi=state.buffers.length>1;
  state.buffers.forEach((s,idx)=>{
    const d=document.createElement('div'); d.className='fader-strip';
    d.innerHTML=`<input type="range" class="mini-fader" min="-24" max="6" value="0" ${multi?"":"disabled"}><div class="stem-name" title="${s.name}">${(s.name||("Trk "+idx)).slice(0,18)}</div>`;
    const fader=d.querySelector('input');
    if(multi){ fader.oninput=(e)=>{ s.gain=parseFloat(e.target.value); renderMix(state.buffers).then(b=>{state.sumBuffer=b; setAudioFromBuffer($('audioOrig'), 'orig', b);}); }; }
    $('mixerBay').appendChild(d);
  });
}
async function renderMix(stems){
  if(stems.length===1)return stems[0].buffer;
  const maxLen=Math.max(...stems.map(s=>s.buffer.length));
  const off=new OfflineAudioContext(2,maxLen,stems[0].buffer.sampleRate);
  stems.forEach(s=>{
      const src=off.createBufferSource(); src.buffer=s.buffer; const g=off.createGain(); g.gain.value=dbToGain(s.gain);
      src.connect(g).connect(off.destination); src.start(0);
  });
  return await off.startRendering();
}

/* MASTERING */
$('btnMasterNow').onclick=async()=>{
  await unlockAudio(); if(!state.sumBuffer)return;
  $('loader').style.display='flex'; setPill('mastPill','MASTERING...','status-busy');
  
  // DSP PARAMS
  const p={target:parseFloat($('k-target').dataset.val), ceil:parseFloat($('k-ceiling').dataset.val), drive:parseFloat($('k-drive').dataset.val)/100, width:parseFloat($('k-width').dataset.val)/100, char:parseFloat($('k-char').dataset.val), hpf:$('sw-hpf').classList.contains('active'), mud:$('sw-mud').classList.contains('active'), air:$('sw-air').classList.contains('active'), multi:$('sw-multi').classList.contains('active'), tube:$('sw-tube').classList.contains('active'), mono:$('sw-mono').classList.contains('active')};
  
  const tok=++renderToken;
  setTimeout(async()=>{
     // SIMPLE DSP CHAIN (No FFmpeg required for this part to ensure it runs)
     const off=new OfflineAudioContext(2,state.sumBuffer.length,state.sumBuffer.sampleRate);
     const src=off.createBufferSource(); src.buffer=state.sumBuffer; let chain=src;
     
     // 1. Gain
     const pre=off.createGain(); pre.gain.value=dbToGain(3 + p.drive*6); chain.connect(pre); chain=pre;
     // 2. EQ
     if(p.hpf){const f=off.createBiquadFilter(); f.type='highpass'; f.frequency.value=30; chain.connect(f); chain=f;}
     if(p.mud){const f=off.createBiquadFilter(); f.type='peaking'; f.frequency.value=300; f.gain.value=-2.5*p.drive; chain.connect(f); chain=f;}
     if(p.air){const f=off.createBiquadFilter(); f.type='highshelf'; f.frequency.value=10000; f.gain.value=3.0*p.drive; chain.connect(f); chain=f;}
     // 3. Limit
     const lim=off.createDynamicsCompressor(); lim.threshold.value=p.ceil; lim.ratio.value=20; lim.attack.value=0.003; lim.release.value=0.1;
     chain.connect(lim); chain=lim;
     
     lim.connect(off.destination); src.start(0);
     
     const rendered=await off.startRendering();
     if(tok!==renderToken)return;
     
     // DONE
     state.masterBuffer=rendered;
     setAudioFromBuffer($('audioMast'), 'mast', state.masterBuffer);
     setPill('mastPill','MASTERED','status-ok');
     $('btnMastPlay').disabled=false; $('btnMastStop').disabled=false; $('exportBtn').disabled=false;
     $('loader').style.display='none';
     
     // Auto Play
     stopAllPlayers(); $('audioMast').play();
  }, 100);
};

/* BUTTONS */
$('btnOrigPlay').onclick=()=>{stopAllPlayers(); $('audioOrig').play();};
$('btnMastPlay').onclick=()=>{stopAllPlayers(); $('audioMast').play();};
$('btnRefPlay').onclick=()=>{stopAllPlayers(); $('audioRef').play();};
$('btnOrigStop').onclick=()=>{stopAllPlayers();}; $('btnMastStop').onclick=()=>{stopAllPlayers();}; $('btnRefStop').onclick=()=>{stopAllPlayers();};

// Visualizer Hook (Simple)
// Note: Real visualizer requires MediaElementSource which has CORS issues with Blob URLs in some browsers. 
// For stability in single-file, we rely on native controls.
</script>
</body>
</html>
