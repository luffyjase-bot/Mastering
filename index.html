<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>AceMaster 5000 — Clear UX</title>
<script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/browser-id3-writer@4.4.0/dist/browser-id3-writer.min.js"></script>

<style>
  /* --- THEME --- */
  :root {
    --chassis: #e0e5ec;
    --ink: #2b2b2b;
    --accent: #ffcc00;
    --accent-dim: #d4b000;
    --led-off: #444;
    --led-on: #00ff41;
    --led-busy: #ffaa00;
    --led-warn: #ff3333;
    
    --shadow-soft: 9px 9px 16px #a3b1c6, -9px -9px 16px #ffffff;
    --shadow-inset: inset 6px 6px 10px #a3b1c6, inset -6px -6px 10px #ffffff;
    --knob-shadow: 6px 6px 10px rgba(0,0,0,0.15), -2px -2px 5px rgba(255,255,255,0.8);
    --bezel-shadow: inset 2px 2px 5px rgba(0,0,0,0.2), 1px 1px 0 rgba(255,255,255,1);
  }

  body { margin: 0; background: #d0d0d0; font-family: ui-sans-serif, system-ui, sans-serif; color: var(--ink); padding: 20px; display: flex; justify-content: center; min-height: 100vh; user-select: none; }
  .rack { width: 100%; max-width: 1020px; display: flex; flex-direction: column; gap: 25px; position: relative; }

  /* OVERLAYS */
  .drop-zone {
    position: absolute; inset: -20px; background: rgba(255,212,0,0.9); z-index: 999;
    display: flex; align-items: center; justify-content: center;
    font-size: 30px; font-weight: 900; color: #000; text-transform: uppercase;
    opacity: 0; pointer-events: none; transition: opacity 0.2s; border-radius: 10px;
  }
  .drop-active .drop-zone { opacity: 1; pointer-events: all; }

  .loading-overlay {
    position: absolute; inset: 0; background: rgba(255,255,255,0.95); z-index: 500;
    display: none; align-items: center; justify-content: center; flex-direction: column; gap: 15px;
    border-radius: 24px; backdrop-filter: blur(5px);
  }
  .progress-bar-wrap { width: 200px; height: 6px; background: #ddd; border-radius: 3px; overflow: hidden; }
  .progress-bar { height: 100%; background: var(--accent-dim); width: 0%; transition: width 0.1s; }
  .progress-text { font-family: monospace; font-weight: 700; font-size: 14px; color: #555; }

  /* FACEPLATE */
  .faceplate {
    background: var(--chassis); border: 1px solid #fff; border-radius: 20px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.25); padding: 30px; position: relative;
    display: flex; flex-direction: column; gap: 25px;
  }
  .screw {
    position: absolute; width: 14px; height: 14px; background: #888; border-radius: 50%;
    box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5), 1px 1px 0 rgba(255,255,255,0.8);
    background-image: linear-gradient(45deg, transparent 46%, #333 46%, #333 54%, transparent 54%);
  }
  .tl { top: 12px; left: 12px; } .tr { top: 12px; right: 12px; } .bl { bottom: 12px; left: 12px; } .br { bottom: 12px; right: 12px; }

  /* HEADER */
  .brand-strip { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid rgba(0,0,0,0.05); padding-bottom: 15px; }
  .logo { font-size: 26px; font-weight: 900; letter-spacing: -1px; display: flex; align-items: center; gap: 10px; }
  .logo span { background: #222; color: var(--accent); padding: 2px 8px; border-radius: 4px; font-size: 14px; letter-spacing: 2px; }
  .model-id { font-family: monospace; font-weight: 700; color: #888; font-size: 12px; }

  /* METER BRIDGE */
  .meter-bridge {
    display: grid; grid-template-columns: 2fr 1fr; gap: 15px; height: 160px;
    background: #222; padding: 15px; border-radius: 12px; border: 2px solid #444;
    box-shadow: inset 0 0 20px #000;
  }
  .screen-wrap { background: #000; border-radius: 6px; border: 1px solid #333; position: relative; overflow: hidden; }
  canvas { width: 100%; height: 100%; display: block; }
  .screen-glare { position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,0.05), transparent 40%); pointer-events: none; }
  .screen-overlay { position: absolute; top: 10px; left: 15px; right: 15px; display: flex; justify-content: space-between; pointer-events: none; }
  .badge { background: rgba(255,212,0,0.9); color: #000; padding: 3px 6px; font-size: 10px; font-weight: 900; border-radius: 3px; }
  .metric { font-family: monospace; color: var(--accent); font-size: 12px; text-shadow: 0 0 5px var(--accent); }
  .warn-msg { position: absolute; bottom: 10px; left: 15px; color: var(--led-warn); font-weight: 900; font-size: 10px; text-transform: uppercase; animation: blink 1s infinite; display: none; }

  .vu-section { display: flex; flex-direction: column; gap: 5px; }
  .vu-header { display:flex; justify-content:space-between; align-items:center; }
  .vu-box { flex: 1; background: #e8e8e0; border-radius: 4px; position: relative; overflow: hidden; box-shadow: inset 0 0 15px rgba(0,0,0,0.4); border: 1px solid #000; }
  .vu-scale { position: absolute; bottom: 10px; left: 10%; right: 10%; height: 2px; background: #333; }
  .vu-needle { width: 2px; height: 85%; background: #d00; position: absolute; bottom: 0; left: 50%; transform-origin: bottom center; transform: rotate(45deg); transition: transform 0.1s ease-out; box-shadow: 2px 2px 4px rgba(0,0,0,0.3); z-index: 2; }
  .vu-label { text-align: center; color: #666; font-size: 10px; font-weight: 800; margin-top: -30px; z-index: 1; position: relative; }
  .vu-title { color: #888; font-size: 10px; text-align: center; font-weight: 700; text-transform: uppercase; }

  .clip-led { width: 12px; height: 12px; border-radius: 50%; background: #400; border: 1px solid #222; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5); cursor: pointer; transition: 0.1s; }
  .clip-led.clipped { background: #ff0000; box-shadow: 0 0 10px #ff0000; }

  /* TOOLBAR */
  .toolbar { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }
  .preset-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
  .target-row { display: flex; justify-content: center; gap: 5px; opacity: 0.8; }
  
  .preset-btn, .target-btn {
    background: var(--chassis); color: #666; border: none; padding: 8px 14px; border-radius: 6px;
    font-size: 10px; font-weight: 800; letter-spacing: 1px; cursor: pointer;
    box-shadow: var(--shadow-soft); transition: all 0.1s; min-width: 60px;
  }
  .preset-btn:active, .preset-btn.active, .target-btn:active {
    box-shadow: var(--shadow-inset); color: #222; border-left: 3px solid var(--accent); transform: translateY(1px);
  }
  .target-btn { background: #ccc; min-width: auto; padding: 4px 8px; }
  .preset-desc { text-align: center; font-size: 10px; font-weight: 700; color: #777; font-style: italic; min-height: 14px; }

  /* CONTROLS */
  .knob-deck { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; background: linear-gradient(to bottom, #f9f9f9, #e0e0e0); padding: 25px; border-radius: 12px; box-shadow: var(--bezel-shadow); border: 1px solid #ccc; transition: opacity 0.3s; }
  .knob-deck.hidden { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
  .module { display: flex; flex-direction: column; align-items: center; gap: 10px; }
  .mod-name { font-size: 10px; font-weight: 800; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
  .knob-pot { width: 64px; height: 64px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #fff, #ccc); box-shadow: var(--knob-shadow); position: relative; cursor: ns-resize; }
  .knob-pot::after { content: ''; position: absolute; top: 5px; left: 50%; width: 4px; height: 20px; background: #333; transform: translateX(-50%); border-radius: 2px; }
  .knob-inner { width: 100%; height: 100%; transition: transform 0.05s; border-radius: 50%; }
  .knob-val { font-family: monospace; font-size: 11px; font-weight: 700; color: var(--ink); background: #fff; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; }

  /* SWITCHES */
  .switch-row { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin-top: 15px; transition: opacity 0.3s; }
  .switch-row.hidden { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
  .push-switch { appearance: none; border: none; background: var(--chassis); color: #666; padding: 8px 14px; border-radius: 8px; font-size: 10px; font-weight: 800; box-shadow: var(--shadow-soft); cursor: pointer; transition: 0.1s; }
  .push-switch.active { box-shadow: var(--shadow-inset); color: #222; border-left: 3px solid var(--accent); }

  /* FOOTER */
  .footer { background: #2a2a2a; border-radius: 12px; padding: 20px; display: flex; justify-content: space-between; align-items: center; color: #fff; margin-top: 20px; flex-wrap:wrap; gap:15px; }
  .transport { display: flex; gap: 10px; align-items: center; }
  .t-btn { width: auto; padding: 0 16px; height: 40px; border-radius: 6px; border: 1px solid #555; background: #333; color: #888; font-size: 11px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .t-btn.active { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 10px rgba(255,212,0,0.2); }
  .t-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .file-group { display: flex; gap: 10px; }
  .file-btn { background: #444; padding: 10px 14px; border-radius: 6px; font-size: 10px; font-weight: 700; cursor: pointer; position: relative; overflow: hidden; display: flex; align-items: center; gap: 5px; }
  .file-btn:hover { background: #555; }
  .file-btn input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .big-go { background: var(--accent); color: #000; border: none; padding: 10px 25px; font-weight: 900; font-size: 14px; box-shadow: 0 0 15px var(--accent); cursor: pointer; }
  .big-go:disabled { background: #555; color: #888; box-shadow: none; cursor: not-allowed; }
  .bit-select { background: #444; color: #fff; border: 1px solid #666; border-radius: 4px; font-size: 10px; font-weight: 700; padding: 5px; }

  /* DRAWER */
  .drawer { background: #222; margin-top: -5px; border-radius: 0 0 12px 12px; padding: 20px; border: 1px solid #444; border-top: none; }
  .drawer.locked { opacity: 0.6; filter: grayscale(1); pointer-events: none; }
  .drawer-head { color: #666; font-size: 10px; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; }
  .drawer-sub { color: #9a9a9a; font-size: 10px; margin-bottom: 10px; font-style: italic; }
  .mixer-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
  .fader-strip { min-width: 80px; background: #1a1a1a; padding: 10px 5px; border-radius: 4px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
  .mini-fader { -webkit-appearance: slider-vertical; width: 24px; height: 100px; background: #333; }
  .stem-name { font-size: 10px; color: #aaa; width: 100%; overflow: hidden; text-overflow: ellipsis; text-align: center; font-weight: 700; }

  .led { width: 10px; height: 10px; border-radius: 50%; background: var(--led-off); box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5); border: 1px solid #222; transition: 0.2s; }
  .led.on { background: var(--led-on); box-shadow: 0 0 8px var(--led-on); }
  .led.busy { background: var(--led-busy); box-shadow: 0 0 8px var(--led-busy); animation: blink 0.5s infinite; }
  .led.warn { background: var(--led-warn); box-shadow: 0 0 8px var(--led-warn); }
  @keyframes blink { 50% { opacity: 0.5; } }

  /* MODAL */
  .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
  .modal-box { background: #eee; padding: 20px; border-radius: 12px; max-width: 450px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.8); font-family: ui-monospace, monospace; font-size: 12px; line-height: 1.6; max-height: 90vh; overflow-y: auto; user-select: text; }
  .report-line { margin-bottom: 5px; border-bottom: 1px dashed #ccc; padding-bottom: 2px; }
  input { border: 1px solid #ccc; padding: 4px; border-radius: 4px; font-family: inherit; font-size: 12px; }
  
  .mode-toggle { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 10px; }
  .toggle-switch { position: relative; width: 60px; height: 24px; }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 12px; box-shadow: var(--shadow-inset); }
  .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
  input:checked + .slider { background-color: var(--ink); }
  input:checked + .slider:before { transform: translateX(36px); background-color: var(--accent); }

  @media(max-width: 800px) { .knob-deck { grid-template-columns: 1fr 1fr 1fr; } .meter-bridge { grid-template-columns: 1fr; height: auto; } .vu-section { display: none; } .footer { flex-direction: column; gap: 15px; } }
</style>
</head>
<body>

<script type="module">
  const workerCode = `
    import { FFmpeg } from "https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/esm/index.js";
    import { toBlobURL } from "https://unpkg.com/@ffmpeg/util@0.12.1/dist/esm/index.js";

    let ffmpeg = null;
    let ffReady = false;
    let cancelled = false;

    function parseLoudnorm(text) {
      const matches = text.match(/\\{[\\s\\S]*?\\}/g);
      if (!matches) return null;
      try { return JSON.parse(matches[matches.length - 1]); } catch { return null; }
    }

    function parseEbur128(text) {
      const iMatch = text.match(/\\bI:\\s*([-\\d.]+)\\s*LUFS/i);
      const tpMatch = text.match(/\\bTP:\\s*([-\\d.]+)\\s*dB(?:TP)?/i);
      const lraMatch = text.match(/\\bLRA:\\s*([-\\d.]+)\\s*LU/i);
      return {
        I: iMatch ? parseFloat(iMatch[1]) : null,
        TP: tpMatch ? parseFloat(tpMatch[1]) : null,
        LRA: lraMatch ? parseFloat(lraMatch[1]) : null
      };
    }

    async function ensureFFmpeg() {
      if (ffReady) return true;
      ffmpeg = new FFmpeg();
      const baseURL = "https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm";
      await ffmpeg.load({
        coreURL: await toBlobURL(\`\${baseURL}/ffmpeg-core.js\`, "text/javascript"),
        wasmURL: await toBlobURL(\`\${baseURL}/ffmpeg-core.wasm\`, "application/wasm"),
      });
      ffReady = true;
      return true;
    }

    async function analyzeLoudness(wavBytes) {
      cancelled = false;
      await ensureFFmpeg();
      const inName = "scan.wav";
      await ffmpeg.writeFile(inName, new Uint8Array(wavBytes));
      let logs = "";
      ffmpeg.on("log", ({ message }) => { logs += message + "\\n"; });
      await ffmpeg.exec(["-i", inName, "-af", "ebur128=peak=true", "-f", "null", "-"]);
      await ffmpeg.deleteFile(inName);
      if (cancelled) return { cancelled: true };
      return { cancelled: false, metrics: parseEbur128(logs) };
    }

    async function applyCompliance(wavBytes, targetI, targetTP) {
      cancelled = false;
      await ensureFFmpeg();
      const inName = "source.wav";
      const outName = "master.wav";
      await ffmpeg.writeFile(inName, new Uint8Array(wavBytes));
      let logs = "";
      ffmpeg.on("log", ({ message }) => { logs += message + "\\n"; });
      
      await ffmpeg.exec(["-i", inName, "-af", \`loudnorm=I=\${targetI}:TP=\${targetTP}:print_format=json\`, "-f", "null", "-"]);
      const meas = parseLoudnorm(logs);
      if (!meas) return { cancelled: false, error: "loudnorm measure failed" };
      if (cancelled) return { cancelled: true };

      await ffmpeg.exec([
        "-i", inName,
        "-af", \`loudnorm=I=\${targetI}:TP=\${targetTP}:measured_I=\${meas.input_i}:measured_LRA=\${meas.input_lra}:measured_TP=\${meas.input_tp}:measured_thresh=\${meas.input_thresh}:offset=\${meas.target_offset}:linear=true:print_format=json\`,
        "-ar", "44100", outName
      ]);

      const data = await ffmpeg.readFile(outName);
      await ffmpeg.deleteFile(inName); await ffmpeg.deleteFile(outName);
      if (cancelled) return { cancelled: true };
      return { cancelled: false, buffer: data.buffer, stats: meas };
    }

    self.onmessage = async (e) => {
      const { id, op, wavBytes, targetI, targetTP } = e.data || {};
      try {
        if (op === "cancel") {
          cancelled = true;
          self.postMessage({ id, ok: true, cancelled: true });
          return;
        }
        if (op === "analyze") {
          const res = await analyzeLoudness(wavBytes);
          self.postMessage({ id, ok: true, ...res });
          return;
        }
        if (op === "compliance") {
          const res = await applyCompliance(wavBytes, targetI, targetTP);
          self.postMessage({ id, ok: true, ...res });
          return;
        }
      } catch (err) {
        self.postMessage({ id, ok: false, error: String(err?.message || err) });
      }
    };
  `;

  const ffWorker = new Worker(URL.createObjectURL(new Blob([workerCode], { type: "text/javascript" })), { type: "module" });
  let _reqId = 0; const pending = new Map();

  function callWorker(op, payload = {}) {
    const id = ++_reqId;
    return new Promise((resolve, reject) => {
      pending.set(id, { resolve, reject });
      ffWorker.postMessage({ id, op, ...payload }, payload.wavBytes ? [payload.wavBytes] : []);
    });
  }

  ffWorker.onmessage = (e) => {
    const { id, ok, ...rest } = e.data || {};
    const p = pending.get(id);
    if (!p) return;
    pending.delete(id);
    ok ? p.resolve(rest) : p.reject(new Error(rest.error || "Worker error"));
  };

  window.__ff = {
    analyze: (wavBytes) => callWorker("analyze", { wavBytes }),
    compliance: (wavBytes, targetI, targetTP) => callWorker("compliance", { wavBytes, targetI, targetTP }),
    cancel: () => callWorker("cancel", {})
  };
</script>

<div class="rack" id="rack">
  <div class="drop-zone">Drop Files Here</div>
  <div class="loading-overlay" id="loader">
    <div class="spinner"></div>
    <div class="progress-text" id="progressText">PROCESSING...</div>
    <div class="progress-bar-wrap"><div class="progress-bar" id="progressBar"></div></div>
    <button class="push-switch" id="cancelBtn" style="margin-top:15px;">CANCEL</button>
  </div>
  <div class="faceplate">
    <div class="screw tl"></div><div class="screw tr"></div><div class="screw bl"></div><div class="screw br"></div>
    <div class="brand-strip">
      <div class="logo">AceMaster <span>5000</span></div>
      <div style="display:flex; align-items:center; gap:10px;">
        <div class="mode-toggle">
          <span style="font-size:10px; font-weight:800; color:#666;">AUTO</span>
          <label class="toggle-switch" title="Auto hides controls">
            <input type="checkbox" id="proModeToggle">
            <span class="slider"></span>
          </label>
          <span style="font-size:10px; font-weight:800; color:#222;">PRO</span>
        </div>
        <div id="statusLed" class="led"></div>
      </div>
    </div>
    <div class="meter-bridge">
      <div class="screen-wrap">
        <canvas id="fftCanvas"></canvas>
        <div class="screen-glare"></div>
        <div class="screen-overlay">
          <span class="badge" id="modeBadge">READY</span>
          <span class="metric" id="kpiMetric">-Inf LUFS</span>
        </div>
        <div class="warn-msg" id="warnMsg">⚠️ PHASE ISSUE</div>
      </div>
      <div class="vu-section">
        <div class="vu-header"><div class="vu-title">Reduction</div><div class="clip-led" id="clipLed" title="Clip Warning"></div></div>
        <div class="vu-box"><div class="vu-scale"></div><div class="vu-needle" id="vuNeedle"></div><div class="vu-label">GR</div></div>
      </div>
    </div>
    <div class="toolbar">
      <div class="target-row">
        <button class="target-btn" onclick="setKnobValue('k-target',-14);setKnobValue('k-ceiling',-1.0);">Spotify -14</button>
        <button class="target-btn" onclick="setKnobValue('k-target',-16);setKnobValue('k-ceiling',-1.0);">Apple -16</button>
        <button class="target-btn" onclick="setKnobValue('k-target',-9);setKnobValue('k-ceiling',-0.5);">Club -9</button>
      </div>
      <div class="preset-row" id="presetRow"></div>
      <div class="preset-desc" id="presetDesc">Select a preset to begin</div>
    </div>
    <div class="knob-deck hidden" id="knobDeck">
      <div class="module"><div class="mod-name">Target</div><div class="knob-pot" id="k-target" data-min="-18" data-max="-6" data-val="-14" data-step="0.5" title="Integrated LUFS"><div class="knob-inner"></div></div><div class="knob-val">-14 LUFS</div></div>
      <div class="module"><div class="mod-name">Ceiling</div><div class="knob-pot" id="k-ceiling" data-min="-3.0" data-max="0.0" data-val="-1.0" data-step="0.1" title="True Peak Limit"><div class="knob-inner"></div></div><div class="knob-val">-1.0 dB</div></div>
      <div class="module"><div class="mod-name" style="color:var(--accent-dim)">Drive %</div><div class="knob-pot" id="k-drive" data-min="0" data-max="100" data-val="40" data-step="1" title="Harmonic Saturation"><div class="knob-inner"></div></div><div class="knob-val">40%</div></div>
      <div class="module"><div class="mod-name">Character</div><div class="knob-pot" id="k-char" data-min="0" data-max="100" data-val="50" data-step="10" title="Punch (Slow) vs Smooth (Fast)"><div class="knob-inner"></div></div><div class="knob-val">Balanced</div></div>
      <div class="module"><div class="mod-name">Width</div><div class="knob-pot" id="k-width" data-min="100" data-max="150" data-val="110" data-step="1" title="M/S Stereo Widener"><div class="knob-inner"></div></div><div class="knob-val">110%</div></div>
    </div>
    <div class="switch-row hidden" id="switchRow">
      <button class="push-switch active" id="sw-hpf" title="Cut Sub <30Hz">HPF 30</button>
      <button class="push-switch active" id="sw-mud" title="Clean Low-Mids">Low Clean</button>
      <button class="push-switch active" id="sw-air" title="Boost Highs">Air 12k</button>
      <button class="push-switch active" id="sw-multi" title="Linkwitz-Riley Multiband">Multiband</button>
      <button class="push-switch active" id="sw-tube" title="Tube Saturation">Tube</button>
      <button class="push-switch active" id="sw-mono" title="Mono Bass <120Hz">Mono Bass</button>
      <button class="push-switch active" id="sw-dither" title="Add TPDF Dither">Dither</button>
      <button class="push-switch active" id="sw-abmatch" title="Auto-match A/B level">A/B Match</button>
    </div>
    <div class="footer">
      <div class="file-group">
        <label class="file-btn"><span>SOURCE</span><input type="file" id="fileInput" accept=".wav,.mp3,.ogg,audio/*" multiple></label>
        <label class="file-btn" style="background:#333;"><span>REF TRACK</span><input type="file" id="refInput" accept=".wav,.mp3,.ogg,audio/*"></label>
        <button class="push-switch" id="matchBtn" disabled style="padding:6px 10px; font-size:9px;">MATCH REF</button>
      </div>
      <div class="transport">
        <button class="t-btn" id="playOrig" title="Original (Space)">Original</button>
        <button class="t-btn" id="playMast" disabled title="Mastered (Space)">Mastered</button>
        <button class="t-btn" id="playRef" disabled title="Reference">Reference</button>
        <button class="t-btn" id="stopBtn" title="Stop">Stop</button>
        <button class="t-btn" id="monoCheckBtn" title="Check Mono Compatibility">Mono</button>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="push-switch" id="undoBtn" disabled title="Undo Change">UNDO</button>
        <button class="push-switch" id="tagsBtn" title="Edit Metadata">TAGS</button>
        <button class="push-switch" id="resetBtn" title="Reset Preset">RESET</button>
        <select id="exportFmt" class="bit-select"><option value="wav">WAV</option><option value="mp3">MP3</option></select>
        <select id="exportBit" class="bit-select"><option value="16">16-bit</option><option value="24">24-bit</option><option value="32">32-bit</option></select>
        <button class="big-go" id="processBtn" disabled>PROCESS</button>
        <button class="big-go" id="exportBtn" disabled style="background:#fff; color:#000;">SAVE</button>
        <button class="push-switch" id="helpBtn" style="padding:10px;">?</button>
      </div>
    </div>
  </div>
  <div class="drawer" id="stemDrawer">
    <div class="drawer-head" id="stemHead">FILES</div>
    <div class="drawer-sub" id="stemSub">Load audio to see stems here.</div>
    <div class="mixer-row" id="mixerBay"></div>
  </div>
  <div class="modal" id="reportModal"><div class="modal-box" id="reportContent"></div></div>
  <div class="modal" id="tagsModal"><div class="modal-box"><b>Publisher Metadata</b><br><br><label>Title<br><input id="mTitle" style="width:100%"></label><br><br><label>Artist<br><input id="mArtist" style="width:100%"></label><br><br><label>Album<br><input id="mAlbum" style="width:100%"></label><br><br><div style="display:flex; gap:10px;"><label style="flex:1;">Year<br><input id="mYear" style="width:100%"></label><label style="flex:1;">Genre<br><input id="mGenre" style="width:100%"></label></div><br><label>ISRC<br><input id="mISRC" style="width:100%" placeholder="CC-XXX-YY-NNNNN"></label><br><br><label>Copyright<br><input id="mCopy" style="width:100%"></label><br><br><label>Cover Art (JPG/PNG)<br><input type="file" id="mCover" accept="image/*" style="width:100%"></label><br><br><div style="display:flex; gap:10px; justify-content:flex-end;"><button class="push-switch" id="tagsClose">CLOSE</button><button class="push-switch active" id="tagsSave">SAVE</button></div></div></div>
</div>

<script>
/* UTILS */
const $ = id => document.getElementById(id);
const dbToGain = db => Math.pow(10, db/20);
const gainToDb = g => 20 * Math.log10(Math.max(g, 1e-12));
const clamp = (x,a,b) => Math.max(a, Math.min(b,x));
function setProgress(pct, text) { $('progressText').innerText = text || "PROCESSING..."; $('progressBar').style.width = `${clamp(pct,0,100)}%`; }

/* UI */
const canvas=$('fftCanvas'), ctx=canvas.getContext('2d'); let dims={w:0,h:0};
function resize() { const r=canvas.getBoundingClientRect(), d=window.devicePixelRatio||1; canvas.width=Math.max(1,Math.floor(r.width*d)); canvas.height=Math.max(1,Math.floor(r.height*d)); ctx.setTransform(d,0,0,d,0,0); dims={w:r.width,h:r.height}; }
window.addEventListener('resize', resize); resize();
function updateVU(db) { const d=Math.max(-12,Math.min(0,db)), deg=45+(d/12)*-90; $('vuNeedle').style.transform=`rotate(${deg}deg)`; }
$('proModeToggle').addEventListener('change', (e) => { const s=e.target.checked; $('knobDeck').classList.toggle('hidden',!s); $('switchRow').classList.toggle('hidden',!s); });

let knobHistory=[]; function setKnobValue(id,val,rec=true){ const el=$(id); if(!el)return; if(rec){knobHistory.push({id,val:parseFloat(el.dataset.val)}); if(knobHistory.length>20)knobHistory.shift(); $('undoBtn').disabled=false;} const min=parseFloat(el.dataset.min), max=parseFloat(el.dataset.max), step=parseFloat(el.dataset.step); val=Math.max(min,Math.min(max,val)); val=Math.round(val/step)*step; el.dataset.val=val; el.dataset.default=el.dataset.default||val; const pct=(val-min)/(max-min), deg=-135+(pct*270); el.querySelector(".knob-inner").style.transform=`rotate(${deg}deg)`; let txt=(val%1===0?val:val.toFixed(1)); if(id==="k-char")txt=val<30?"Punch":val>70?"Smooth":"Balanced"; const sfx=id.includes("target")?" LUFS":id.includes("ceiling")?" dB":(id.includes("width")||id.includes("drive"))?"%":""; el.nextElementSibling.innerText=`${txt}${sfx}`; }
$('undoBtn').onclick=()=>{if(!knobHistory.length)return; const l=knobHistory.pop(); setKnobValue(l.id,l.val,false); if(!knobHistory.length)$('undoBtn').disabled=true;};

document.querySelectorAll('.knob-pot').forEach(el=>{ setKnobValue(el.id,parseFloat(el.dataset.val),false); let startY,startVal; el.addEventListener('mousedown',e=>{ startY=e.clientY; startVal=parseFloat(el.dataset.val); const min=parseFloat(el.dataset.min), max=parseFloat(el.dataset.max); const onMove=m=>{ const delta=startY-m.clientY; setKnobValue(el.id,startVal+(delta/200)*(max-min)); }; const onUp=()=>{ window.removeEventListener('mousemove',onMove); window.removeEventListener('mouseup',onUp); }; window.addEventListener('mousemove',onMove); window.addEventListener('mouseup',onUp); }); el.addEventListener('dblclick',()=>setKnobValue(el.id,parseFloat(el.dataset.default),true)); });
function setSwitch(id,on){ const el=$(id); if(el)el.classList.toggle("active",!!on); }
document.querySelectorAll('.push-switch[id^="sw-"]').forEach(b=>b.onclick=()=>b.classList.toggle('active'));

const meta={title:"",artist:"",album:"",year:"",genre:"",isrc:"",copyright:"",coverBuffer:null,coverMime:"image/jpeg"};
$('tagsBtn').onclick=()=>{ $('mTitle').value=meta.title; $('mArtist').value=meta.artist; $('mAlbum').value=meta.album; $('mYear').value=meta.year; $('mGenre').value=meta.genre; $('mISRC').value=meta.isrc; $('mCopy').value=meta.copyright; $('tagsModal').style.display='flex'; };
$('tagsClose').onclick=()=>$('tagsModal').style.display='none';
$('tagsSave').onclick=()=>{ meta.title=$('mTitle').value; meta.artist=$('mArtist').value; meta.album=$('mAlbum').value; meta.year=$('mYear').value; meta.genre=$('mGenre').value; meta.isrc=$('mISRC').value; meta.copyright=$('mCopy').value; const f=$('mCover').files[0]; if(f){meta.coverMime=f.type||'image/jpeg'; const r=new FileReader(); r.onload=e=>meta.coverBuffer=e.target.result; r.readAsArrayBuffer(f);} $('tagsModal').style.display='none'; };

const PRESETS=[{key:"pop",name:"POP",desc:"Clean loud, shiny top",knobs:{target:-10.5,ceiling:-0.9,drive:35,width:115,char:55},switches:{hpf:true,mud:true,air:true,multi:true,tube:false,mono:true,dither:true}},{key:"trap",name:"TRAP",desc:"808 weight + snap",knobs:{target:-9.5,ceiling:-0.8,drive:55,width:108,char:35},switches:{hpf:true,mud:true,air:false,multi:true,tube:true,mono:true,dither:true}},{key:"edm",name:"EDM",desc:"Bright, wide, club loud",knobs:{target:-8.5,ceiling:-0.5,drive:50,width:135,char:45},switches:{hpf:true,mud:false,air:true,multi:true,tube:false,mono:true,dither:true}},{key:"rock",name:"ROCK",desc:"Punchy glue, guitars fwd",knobs:{target:-10.0,ceiling:-0.8,drive:45,width:110,char:25},switches:{hpf:true,mud:true,air:true,multi:true,tube:true,mono:true,dither:true}},{key:"rnb",name:"R&B",desc:"Warm + smooth",knobs:{target:-11.5,ceiling:-1.0,drive:40,width:120,char:75},switches:{hpf:true,mud:true,air:true,multi:false,tube:true,mono:true,dither:true}}];
const pr=$('presetRow'); pr.innerHTML=PRESETS.map(p=>`<button class="preset-btn" data-key="${p.key}" title="${p.desc}">${p.name}</button>`).join("");
let curPreset='pop';
const applyPreset=(k)=>{ const p=PRESETS.find(x=>x.key===k); setKnobValue("k-target",p.knobs.target,false); setKnobValue("k-ceiling",p.knobs.ceiling,false); setKnobValue("k-drive",p.knobs.drive,false); setKnobValue("k-width",p.knobs.width,false); setKnobValue("k-char",p.knobs.char,false); setSwitch("sw-hpf",p.switches.hpf); setSwitch("sw-mud",p.switches.mud); setSwitch("sw-air",p.switches.air); setSwitch("sw-multi",p.switches.multi); setSwitch("sw-tube",p.switches.tube); setSwitch("sw-mono",p.switches.mono); setSwitch("sw-dither",p.switches.dither); document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active')); pr.querySelector(`[data-key="${k}"]`).classList.add('active'); $('presetDesc').innerText=p.desc; $('modeBadge').innerText=p.name; curPreset=k; knobHistory=[]; $('undoBtn').disabled=true; };
document.querySelectorAll('.preset-btn').forEach(b=>b.onclick=()=>applyPreset(b.dataset.key)); const rb=$('resetBtn'); if(rb)rb.onclick=()=>applyPreset(curPreset); applyPreset('pop');

/* AUDIO */
const audioCtx=new(window.AudioContext||window.webkitAudioContext)(); let audioUnlocked=false; let renderToken=0; let myTokenForExport=0;
async function unlockAudio(){if(audioUnlocked)return; try{if(audioCtx.state==='suspended')await audioCtx.resume(); const o=audioCtx.createOscillator(),g=audioCtx.createGain(); g.gain.value=0.00001; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.01); audioUnlocked=true;}catch(e){}}

let state={buffers:[],sumBuffer:null,masterBuffer:null,refBuffer:null,activeSrc:null,analyser:null,analyserL:null,analyserR:null,isPlaying:false,monoMode:false,stats:{input:null,output:null},nowPlaying:'none',currentTime:0,startTime:0};

function applyGain(buf,g){for(let c=0;c<buf.numberOfChannels;c++){const d=buf.getChannelData(c);for(let i=0;i<d.length;i++)d[i]*=g;}}
function makeTubeCurve(d){const n=44100,c=new Float32Array(n),k=d*10;for(let i=0;i<n;i++){let x=i*2/n-1;if(x<-0.5)x+=0.2*(x+0.5)*(x+0.5);c[i]=Math.tanh(k*x)/Math.tanh(k);}return c;}
function makeSoftClipCurve(){const n=44100,c=new Float32Array(n);for(let i=0;i<n;i++){let x=i*2/n-1;c[i]=(3*x-x*x*x)/2;}return c;}
function audioBufferToWavBytes(b){const nc=Math.min(2,b.numberOfChannels),sr=b.sampleRate,l=b.length,bps=2,ba=nc*bps,ds=l*ba; const ab=new ArrayBuffer(44+ds),v=new DataView(ab); const w=(o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i));}; w(0,"RIFF"); v.setUint32(4,36+ds,true); w(8,"WAVE"); w(12,"fmt "); v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,nc,true); v.setUint32(24,sr,true); v.setUint32(28,sr*ba,true); v.setUint16(32,ba,true); v.setUint16(34,16,true); w(36,"data"); v.setUint32(40,ds,true); const c=[]; for(let i=0;i<nc;i++)c.push(b.getChannelData(i)); let p=44; for(let i=0;i<l;i++){for(let j=0;j<nc;j++){let s=Math.max(-1,Math.min(1,c[j][i])); v.setInt16(p,s<0?s*0x8000:s*0x7FFF,true); p+=2;}} return ab;}

// RMS (Fast Load)
function quickRmsAndPeak(buf){const L=buf.getChannelData(0); const R=buf.numberOfChannels>1?buf.getChannelData(1):L; let sum=0,peak=0; for(let i=0;i<L.length;i+=100){const m=0.5*(L[i]+R[i]); sum+=m*m; if(Math.abs(m)>peak)peak=Math.abs(m);} const rms=Math.sqrt(sum/(L.length/100)); return{rmsDb:gainToDb(rms),peakDb:gainToDb(peak)};}

/* IO */
const rack=$('rack'); ['dragenter','dragover'].forEach(e=>rack.addEventListener(e,v=>{v.preventDefault();rack.classList.add('drop-active');})); ['dragleave','drop'].forEach(e=>rack.addEventListener(e,v=>{v.preventDefault();rack.classList.remove('drop-active');})); rack.addEventListener('drop',e=>loadFiles(e.dataTransfer.files)); $('fileInput').onchange=e=>loadFiles(e.target.files);

async function loadFiles(files){
  await unlockAudio(); files=Array.from(files).filter(f=>/\.(wav|mp3|m4a|aac|ogg|flac|aif)$/i.test(f.name||""));
  if(!files.length)return;
  
  $('kpiMetric').innerText="ANALYZING..."; $('warnMsg').style.display='none'; state.buffers=[]; $('mixerBay').innerHTML=''; const failed=[];
  try {
    for(const f of files){
      try{ const ab=await f.arrayBuffer(); const b=await audioCtx.decodeAudioData(ab); state.buffers.push({buffer:b,name:f.name||"Audio",gain:0}); }
      catch(e){ failed.push(f.name); }
    }
    if(!state.buffers.length){ alert("Failed to decode files:\n"+failed.join("\n")); return; }
    
    // UI Update for Stems
    const multi = state.buffers.length > 1;
    $('stemDrawer').style.display = 'block';
    $('stemHead').innerText = multi ? `STEMS (${state.buffers.length})` : "FILE (1)";
    $('stemSub').innerText = multi ? "Optional: Adjust Mix" : "Single File Mode";
    $('stemDrawer').classList.toggle('locked', !multi);
    buildMixer();
    
    state.sumBuffer=await renderMix(state.buffers);
    
    // Fast Stat
    const rough=quickRmsAndPeak(state.sumBuffer);
    state.stats.input={peakDb:rough.peakDb, rmsDb:rough.rmsDb};
    $('kpiMetric').innerText=`IN (rough): ${rough.peakDb.toFixed(1)} dB / ${rough.rmsDb.toFixed(1)} dB`;
    $('modeBadge').innerText = "Original Ready";
    
    const cr=rough.peakDb-rough.rmsDb; let w=""; if(rough.peakDb>-0.5)w="⚠️ HOT INPUT"; else if(cr>18)w="⚠️ VERY DYNAMIC";
    if(w){$('warnMsg').innerText=w; $('warnMsg').style.display='block';}
    
    $('processBtn').disabled=false; $('playOrig').disabled=false; $('statusLed').className='led on';
    resetTransport(); $('playOrig').classList.add('active'); state.nowPlaying='orig';
    if(failed.length)alert("Skipped unsupported files:\n"+failed.join("\n"));
  } catch(e){ console.error(e); alert("Load Error"); }
}
$('refInput').onchange=async(e)=>{const f=e.target.files[0]; if(f){try{const ab=await f.arrayBuffer(); state.refBuffer=await audioCtx.decodeAudioData(ab); $('playRef').disabled=false; $('matchBtn').disabled=false;}catch(e){}}};

function buildMixer(){
  $('mixerBay').innerHTML = "";
  const multi = state.buffers.length > 1;
  state.buffers.forEach((s, idx) => {
    const d = document.createElement('div');
    d.className = 'fader-strip';
    d.innerHTML = `
      <input type="range" class="mini-fader" min="-24" max="6" value="0" ${multi ? "" : "disabled"}>
      <div class="stem-name" title="${s.name}">${(s.name||("Track "+(idx+1))).slice(0,18)}</div>
    `;
    const fader = d.querySelector('input');
    if(multi){
      fader.oninput = (e) => {
        s.gain = parseFloat(e.target.value);
        renderMix(state.buffers).then(b => state.sumBuffer = b);
      };
    }
    $('mixerBay').appendChild(d);
  });
}
async function renderMix(stems){ if(stems.length===1)return stems[0].buffer; const maxLen=Math.max(...stems.map(s=>s.buffer.length)); const off=new OfflineAudioContext(2,maxLen,stems[0].buffer.sampleRate); stems.forEach(s=>{const src=off.createBufferSource(); src.buffer=s.buffer; const g=off.createGain(); g.gain.value=dbToGain(s.gain); src.connect(g).connect(off.destination); src.start(0);}); return await off.startRendering(); }

/* DSP */
$('cancelBtn').onclick=()=>{renderToken++; try{window.__ff.cancel();}catch(e){} $('loader').style.display='none'; $('modeBadge').innerText="CANCELLED"; $('statusLed').className='led warn';};
$('processBtn').onclick=async()=>{
  await unlockAudio(); if(!state.sumBuffer)return;
  $('loader').style.display='flex'; $('statusLed').className='led busy'; setProgress(0,"ANALYZING...");
  const p={target:parseFloat($('k-target').dataset.val), ceil:parseFloat($('k-ceiling').dataset.val), drive:parseFloat($('k-drive').dataset.val)/100, width:parseFloat($('k-width').dataset.val)/100, char:parseFloat($('k-char').dataset.val), hpf:$('sw-hpf').classList.contains('active'), mud:$('sw-mud').classList.contains('active'), air:$('sw-air').classList.contains('active'), multi:$('sw-multi').classList.contains('active'), tube:$('sw-tube').classList.contains('active'), mono:$('sw-mono').classList.contains('active')};
  const tok=++renderToken;
  setTimeout(async()=>{
    if(p.target>-9){if(!p.multi)p.multi=true;if(!p.mono)p.mono=true;}
    const off=new OfflineAudioContext(2,state.sumBuffer.length,state.sumBuffer.sampleRate); const src=off.createBufferSource(); src.buffer=state.sumBuffer; let chain=src;
    const dc=off.createBiquadFilter(); dc.type='highpass'; dc.frequency.value=10; chain.connect(dc); chain=dc;
    let gn=p.target-state.stats.input.rmsDb; gn=clamp(gn,-4,16); const pre=off.createGain(); pre.gain.value=dbToGain(gn); chain.connect(pre); chain=pre;
    setProgress(20,"EQ & DYNAMICS...");
    if(p.hpf){const f=off.createBiquadFilter(); f.type='highpass'; f.frequency.value=30; chain.connect(f); chain=f;}
    if(p.mud){const f=off.createBiquadFilter(); f.type='peaking'; f.frequency.value=300; f.gain.value=-2.5*p.drive; chain.connect(f); chain=f;}
    if(p.air){const f=off.createBiquadFilter(); f.type='highshelf'; f.frequency.value=10000; f.gain.value=3*p.drive; chain.connect(f); chain=f; const de=off.createDynamicsCompressor(); de.threshold.value=-20; de.ratio.value=4; de.attack.value=0.005; de.release.value=0.05; chain.connect(de); chain=de;}
    if(p.multi){
      const lo=off.createBiquadFilter(); lo.type='lowpass'; lo.frequency.value=200; const hi=off.createBiquadFilter(); hi.type='highpass'; hi.frequency.value=200;
      const cL=off.createDynamicsCompressor(); cL.threshold.value=-12; cL.ratio.value=4; cL.attack.value=0.03;
      const cH=off.createDynamicsCompressor(); cH.threshold.value=-24; cH.ratio.value=2; cH.attack.value=0.01;
      const m=off.createGain(); chain.connect(lo); lo.connect(cL); cL.connect(m); chain.connect(hi); hi.connect(cH); cH.connect(m); chain=m;
    }
    if(p.width!==1.0||p.mono){
      const sp=off.createChannelSplitter(2), mg=off.createChannelMerger(2); chain.connect(sp);
      const mid=off.createGain(), gl=off.createGain(); gl.gain.value=0.5; sp.connect(gl,0); gl.connect(mid); const gr=off.createGain(); gr.gain.value=0.5; sp.connect(gr,1); gr.connect(mid);
      const sid=off.createGain(), sl=off.createGain(); sl.gain.value=0.5; sp.connect(sl,0); sl.connect(sid); const sr=off.createGain(); sr.gain.value=-0.5; sp.connect(sr,1); sr.connect(sid);
      let sproc=sid; if(p.mono){const f=off.createBiquadFilter(); f.type='highpass'; f.frequency.value=120; sid.connect(f); sproc=f;}
      const wg=off.createGain(); wg.gain.value=p.width; sproc.connect(wg);
      mid.connect(mg,0,0); mid.connect(mg,0,1); wg.connect(mg,0,0); const inv=off.createGain(); inv.gain.value=-1; wg.connect(inv); inv.connect(mg,0,1); chain=mg;
    }
    if(p.tube){const ws=off.createWaveShaper(); ws.curve=makeTubeCurve(p.drive); ws.oversample='4x'; chain.connect(ws); chain=ws;}
    setProgress(50,"LIMITING...");
    const clp=off.createWaveShaper(); clp.curve=makeSoftClipCurve(); clp.oversample='4x'; chain.connect(clp); chain=clp;
    const lim=off.createDynamicsCompressor(); lim.threshold.value=p.ceil; lim.ratio.value=20; lim.attack.value=0.03-(p.char/100*0.029); lim.release.value=0.1; chain.connect(lim); chain=lim;
    lim.connect(off.destination); src.start(0);
    
    const ren=await off.startRendering(); if(tok!==renderToken)return;
    const fd=Math.floor(ren.sampleRate*0.01);
    for(let c=0;c<ren.numberOfChannels;c++){const d=ren.getChannelData(c); for(let i=0;i<fd;i++){d[i]*=(i/fd); d[d.length-1-i]*=(i/fd);}}
    
    setProgress(70,"COMPLIANCE...");
    const rawWav=audioBufferToWavBytes(ren);
    let comp=null; try{comp=await window.__ff.compliance(rawWav,p.target,p.ceil);}catch(e){console.warn(e);}
    
    if(comp&&comp.buffer){
        state.masterBuffer=await audioCtx.decodeAudioData(comp.buffer);
        setProgress(90,"VERIFYING...");
        const wOut=audioBufferToWavBytes(state.masterBuffer);
        try{
            const mOut=await window.__ff.analyze(wOut);
            state.stats.output={peakDb:mOut.metrics.TP, rmsDb:mOut.metrics.I};
            $('kpiMetric').innerText=`OUT: ${mOut.metrics.TP.toFixed(1)} dBTP / ${mOut.metrics.I.toFixed(1)} LUFS`;
        }catch(e){}
    } else {
        state.masterBuffer=ren; $('kpiMetric').innerText="OUT: (Approx) Rendered";
    }

    $('loader').style.display='none'; $('playMast').disabled=false; $('exportBtn').disabled=false; $('modeBadge').innerText="Mastered Ready"; $('statusLed').className='led on';
    stop(); playBuffer(state.masterBuffer); $('playMast').classList.add('active'); state.nowPlaying='mast';
    $('reportContent').innerHTML=`<b>Final Stats:</b><br>Loudness: ${state.stats.output?.rmsDb.toFixed(1)||"?"} LUFS<br>True Peak: ${state.stats.output?.peakDb.toFixed(1)||"?"} dB<br><br><button class="push-switch" onclick="$('reportModal').style.display='none'">CLOSE</button>`;
    $('reportModal').style.display='flex';
  },100);
};

/* PLAY */
$('monoCheckBtn').onclick=async()=>{ await unlockAudio(); state.monoMode=!state.monoMode; $('monoCheckBtn').classList.toggle('active',state.monoMode); };
let abToggleBound=false;
function playBuffer(buf,isRef=false){
  if(!buf)return;
  const res=state.isPlaying?(audioCtx.currentTime-state.startTime)%buf.duration:0;
  if(state.activeSrc)try{state.activeSrc.stop()}catch(e){}
  state.isPlaying=true; state.startTime=audioCtx.currentTime-res;
  const src=audioCtx.createBufferSource(); src.buffer=buf; const gain=audioCtx.createGain();
  if(!isRef && buf===state.masterBuffer && $('sw-abmatch').classList.contains('active')) {
    const diff=state.stats.input.rmsDb-state.stats.output.rmsDb; gain.gain.value=dbToGain(diff);
  }
  const splitMeter=audioCtx.createChannelSplitter(2); state.anL=audioCtx.createAnalyser(); state.anL.fftSize=1024; state.anR=audioCtx.createAnalyser(); state.anR.fftSize=1024;
  state.analyser=state.anL;
  src.connect(gain); gain.connect(splitMeter); splitMeter.connect(state.anL,0); splitMeter.connect(state.anR,1);
  if(state.monoMode){
      const sp=audioCtx.createChannelSplitter(2), mg=audioCtx.createChannelMerger(2), sm=audioCtx.createGain(); sm.gain.value=0.5;
      gain.connect(sp); const l=audioCtx.createGain(),r=audioCtx.createGain(); sp.connect(l,0); sp.connect(r,1); l.connect(sm); r.connect(sm); sm.connect(mg,0,0); sm.connect(mg,0,1); mg.connect(audioCtx.destination);
  } else gain.connect(audioCtx.destination);
  state.activeSrc=src; src.start(0,res); draw(); src.onended=()=>{};
  
  if(!abToggleBound){
      abToggleBound=true;
      document.addEventListener('keydown',e=>{
        if((document.activeElement?.tagName||'').toLowerCase().match(/input|textarea/))return;
        if(e.code==='Space'&&state.masterBuffer){e.preventDefault(); if(state.nowPlaying==='mast')$('playOrig').click(); else $('playMast').click();}
      });
  }
}
function stop(){if(state.activeSrc)try{state.activeSrc.stop()}catch(e){} state.isPlaying=false; resetTransport();}
function resetTransport(){['playOrig','playMast','playRef'].forEach(id=>$(id).classList.remove('active'));}
$('stopBtn').onclick=async()=>{await unlockAudio(); stop();};
$('playOrig').onclick=async()=>{await unlockAudio(); if(!state.sumBuffer)return; playBuffer(state.sumBuffer); resetTransport(); $('playOrig').classList.add('active'); $('modeBadge').innerText="Playing Original"; state.nowPlaying='orig';};
$('playMast').onclick=async()=>{await unlockAudio(); if(!state.masterBuffer){alert("No master yet. Process first.");return;} playBuffer(state.masterBuffer); resetTransport(); $('playMast').classList.add('active'); $('modeBadge').innerText="Playing Mastered"; state.nowPlaying='mast';};
$('playRef').onclick=async()=>{await unlockAudio(); if(!state.refBuffer)return; playBuffer(state.refBuffer,true); resetTransport(); $('playRef').classList.add('active'); $('modeBadge').innerText="Playing Reference"; state.nowPlaying='ref';};

/* DRAW */
function getCorr(anL,anR){
    const l=new Uint8Array(anL.fftSize), r=new Uint8Array(anR.fftSize); anL.getByteTimeDomainData(l); anR.getByteTimeDomainData(r);
    let slr=0,sl2=0,sr2=0; for(let i=0;i<l.length;i++){const a=(l[i]-128)/128, b=(r[i]-128)/128; slr+=a*b; sl2+=a*a; sr2+=b*b;}
    return slr/(Math.sqrt(sl2*sr2)+1e-9);
}
function draw(){
  if(!state.isPlaying)return;
  const bins=new Uint8Array(state.analyser.frequencyBinCount); state.analyser.getByteFrequencyData(bins);
  ctx.clearRect(0,0,dims.w,dims.h); const bw=dims.w/bins.length;
  for(let i=0;i<bins.length;i++){ const h=(bins[i]/255)*dims.h; ctx.fillStyle=`hsl(${i*2},100%,50%)`; ctx.fillRect(i*bw,dims.h-h,bw,h); }
  const c=getCorr(state.anL,state.anR); if(c<0) $('warnMsg').style.display='block'; else $('warnMsg').style.display='none';
  if(state.nowPlaying==='mast'){updateVU((bins[10]/255)*-12);} else updateVU(0);
  if(bins[5]>250)$('clipLed').classList.add('clipped');
  requestAnimationFrame(draw);
}
$('clipLed').onclick=()=>$('clipLed').classList.remove('clipped');

/* EXPORT */
function floatTo16BitPCM(f){const o=new Int16Array(f.length);for(let i=0;i<f.length;i++){let s=Math.max(-1,Math.min(1,f[i]));o[i]=s<0?s*0x8000:s*0x7FFF;}return o;}
async function encodeMp3(buf,kbps){
    const l=floatTo16BitPCM(buf.getChannelData(0)), r=floatTo16BitPCM(buf.getChannelData(1));
    const enc=new lamejs.Mp3Encoder(2,buf.sampleRate,kbps), mp3=[];
    const sz=1152; 
    for(let i=0;i<l.length;i+=sz){
        if(exportToken!==myTokenForExport)throw new Error("Cancelled");
        const mb=enc.encodeBuffer(l.subarray(i,i+sz),r.subarray(i,i+sz));
        if(mb.length)mp3.push(new Uint8Array(mb));
        if(i%(sz*50)===0){setProgress((i/l.length*100)|0,"ENCODING..."); await new Promise(r=>setTimeout(r,0));}
    }
    const end=enc.flush(); if(end.length)mp3.push(new Uint8Array(end));
    return new Blob(mp3,{type:"audio/mpeg"});
}
async function tagMp3(blob){
    const b=await blob.arrayBuffer(), w=new ID3Writer(b);
    if(meta.title)w.setFrame('TIT2',meta.title); if(meta.artist)w.setFrame('TPE1',[meta.artist]); if(meta.album)w.setFrame('TALB',meta.album);
    if(meta.year)w.setFrame('TYER',meta.year); if(meta.coverBuffer)w.setFrame('APIC',{type:3,data:meta.coverBuffer,description:'Cover',mimeType:meta.coverMime});
    w.addTag(); return new Blob([w.arrayBuffer],{type:"audio/mpeg"});
}

$('exportBtn').onclick=async()=>{
    if(!state.masterBuffer)return;
    const fmt=$('exportFmt').value, safe=(meta.title||"AceMaster").replace(/[^\w\s-]/g,"").trim()||"Track", fn=`${safe}_${$('modeBadge').innerText}_${$('k-target').dataset.val}LUFS`;
    
    if(fmt==='mp3'){
        $('loader').style.display='flex'; $('statusLed').className='led busy'; myTokenForExport=++exportToken;
        try{
            const b=await encodeMp3(state.masterBuffer,320);
            setProgress(90,"TAGGING...");
            const tb=await tagMp3(b);
            const u=URL.createObjectURL(tb), a=document.createElement('a'); a.href=u; a.download=fn+".mp3"; a.click(); setTimeout(()=>URL.revokeObjectURL(u),2000);
        }catch(e){if(e.message!=='Cancelled')alert(e);}
        $('loader').style.display='none'; $('statusLed').className='led on'; return;
    }
    // WAV
    myTokenForExport=++exportToken; $('loader').style.display='flex'; $('statusLed').className='led busy';
    await new Promise(r=>setTimeout(r,50));
    const b=state.masterBuffer, is24=$('exportBit').value==='24', is32=$('exportBit').value==='32', dither=$('sw-dither').classList.contains('active');
    const bps=is32?4:is24?3:2, len=b.length*2*bps, view=new DataView(new ArrayBuffer(44+len));
    const s=(o,str)=>{for(let i=0;i<str.length;i++)view.setUint8(o+i,str.charCodeAt(i));};
    s(0,'RIFF'); view.setUint32(4,36+len,true); s(8,'WAVE'); s(12,'fmt '); view.setUint32(16,16,true); view.setUint16(20,is32?3:1,true); view.setUint16(22,2,true); view.setUint32(24,b.sampleRate,true); view.setUint32(28,b.sampleRate*2*bps,true); view.setUint16(32,2*bps,true); view.setUint16(34,bps*8,true); s(36,'data'); view.setUint32(40,len,true);
    const L=b.getChannelData(0), R=b.getChannelData(1); let p=44; const chk=48000;
    for(let i=0;i<b.length;i++){
        if(exportToken!==myTokenForExport){$('loader').style.display='none'; return;}
        let l=L[i], r=R[i]; if(dither&&!is32){l+=(Math.random()-0.5)*0.00003; r+=(Math.random()-0.5)*0.00003;}
        if(is32){view.setFloat32(p,l,true); view.setFloat32(p+4,r,true); p+=8;}
        else if(is24){
            l=Math.max(-1,Math.min(1,l)); r=Math.max(-1,Math.min(1,r));
            let sl=Math.round(l*0x7FFFFF), sr=Math.round(r*0x7FFFFF);
            if(sl<0)sl+=0x1000000; if(sr<0)sr+=0x1000000;
            view.setUint8(p,sl&0xFF); view.setUint8(p+1,(sl>>8)&0xFF); view.setUint8(p+2,(sl>>16)&0xFF);
            view.setUint8(p+3,sr&0xFF); view.setUint8(p+4,(sr>>8)&0xFF); view.setUint8(p+5,(sr>>16)&0xFF); p+=6;
        } else {
            l=Math.max(-1,Math.min(1,l)); r=Math.max(-1,Math.min(1,r));
            view.setInt16(p,l<0?l*0x8000:l*0x7FFF,true); view.setInt16(p+2,r<0?r*0x8000:r*0x7FFF,true); p+=4;
        }
        if(i%chk===0){ setProgress((i/b.length*100)|0,"WRITING WAV..."); await new Promise(r=>setTimeout(r,0)); }
    }
    const u=URL.createObjectURL(new Blob([view],{type:'audio/wav'})), a=document.createElement('a'); a.href=u; a.download=fn+".wav"; a.click(); setTimeout(()=>URL.revokeObjectURL(u),2000);
    $('loader').style.display='none'; $('statusLed').className='led on';
};
</script>
</body>
</html>
